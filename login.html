<script>
  (function () {
    const SUPABASE_URL = "https://auxhexhkrfyizqjvnpvn.supabase.co";
    const SUPABASE_KEY = "sb_publishable_jSrj1sEIrDuu73hJHhrnXw_vK7mlQeg";

    const supabase =
      window.__LA_SUPABASE__ ||
      (window.__LA_SUPABASE__ = window.supabase.createClient(
        SUPABASE_URL,
        SUPABASE_KEY
      ));

    const msgEl = document.getElementById("msg");
    const submitBtn = document.getElementById("submitBtn");
    const googleBtn = document.getElementById("googleLogin");

    const alreadyBox = document.getElementById("already");
    const goNextBtn = document.getElementById("goNextBtn");
    const logoutBtn = document.getElementById("logoutBtn");

    function showMsg(text, type = "info") {
      msgEl.style.display = "block";
      msgEl.textContent = text;
      msgEl.classList.remove("is-ok", "is-err", "is-info");
      msgEl.classList.add(type === "ok" ? "is-ok" : type === "err" ? "is-err" : "is-info");
    }
    function clearMsg() {
      msgEl.style.display = "none";
      msgEl.textContent = "";
      msgEl.classList.remove("is-ok", "is-err", "is-info");
    }
    function setLoading(v) {
      submitBtn.disabled = v;
      googleBtn.disabled = v;
      submitBtn.style.opacity = v ? "0.7" : "1";
      googleBtn.style.opacity = v ? "0.7" : "1";
    }

    function origin() {
      return window.location.origin;
    }

    function getNext() {
      const p = new URLSearchParams(location.search).get("next");
      return p && p.trim() ? p.trim() : "chat.html";
    }

    function safeNext(next) {
      if (!next || next.includes("http://") || next.includes("https://") || next.startsWith("//")) {
        return "chat.html";
      }
      return next.replace(/^\//, "");
    }

    function nextUrl() {
      return "./" + safeNext(getNext());
    }

    function setAlreadyConnectedUI(isConnected) {
      alreadyBox.style.display = isConnected ? "block" : "none";
      if (isConnected) {
        goNextBtn.href = nextUrl();
      }
    }

    /* ✅ AJOUT MINIMAL: utilitaire pour savoir si on revient de Google OAuth */
    function cameFromOAuth() {
      return new URLSearchParams(location.search).get("oauth") === "1";
    }

    // Garder next dans les liens signup
    const nextEnc = encodeURIComponent(safeNext(getNext()));
    document.getElementById("signupLink").href = "./signup.html?next=" + nextEnc;
    document.getElementById("signupLink2").href = "./signup.html?next=" + nextEnc;

    // ✅ IMPORTANT: on ne redirige jamais automatiquement ici
    // On affiche juste "déjà connecté" si session existe
    (async () => {
      try {
        const { data } = await supabase.auth.getSession();
        if (data?.session) {
          setAlreadyConnectedUI(true);
          showMsg("Tu es déjà connectée.", "ok");
        } else {
          setAlreadyConnectedUI(false);
        }
      } catch (_) {}
    })();

    // ✅ Login email/password : redirection seulement après succès
    document.getElementById("loginForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      clearMsg();

      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value;

      if (!email || !email.includes("@")) return showMsg("Entre un email valide.", "err");
      if (!password || password.length < 6) return showMsg("Mot de passe invalide.", "err");

      setLoading(true);
      showMsg("Connexion…", "info");

      const { data, error } = await supabase.auth.signInWithPassword({ email, password });

      if (error) {
        setLoading(false);
        return showMsg(error.message, "err");
      }

      if (data?.session) {
        showMsg("Connecté. Redirection…", "ok");
        window.location.href = nextUrl();
        return;
      }

      setLoading(false);
      showMsg("Connexion faite, mais session introuvable. Réessaie.", "err");
    });

    // ✅ Google OAuth : on redirige vers login avec ?oauth=1
    document.getElementById("googleLogin").addEventListener("click", async () => {
      clearMsg();
      setLoading(true);
      showMsg("Ouverture de Google…", "info");

      const next = safeNext(getNext());

      const { error } = await supabase.auth.signInWithOAuth({
        provider: "google",
        options: {
          /* ✅ MODIF MINIMALE: on garde oauth=1 */
          redirectTo: origin() + "/login.html?oauth=1&next=" + encodeURIComponent(next),
        },
      });

      if (error) {
        setLoading(false);
        showMsg(error.message, "err");
      }
    });

    // ✅ Au retour OAuth, on peut rediriger SI oauth=1 (et seulement là)
    (async () => {
      if (!cameFromOAuth()) return;

      try {
        const { data } = await supabase.auth.getSession();
        if (data?.session) {
          window.location.href = nextUrl();
        } else {
          setLoading(false);
          showMsg("Connexion Google incomplète. Réessaie.", "err");
        }
      } catch (_) {}
    })();

    // Forgot password
    document.getElementById("forgot").addEventListener("click", async () => {
      clearMsg();

      const email = document.getElementById("email").value.trim();
      if (!email || !email.includes("@")) {
        return showMsg("Entre ton email, puis clique “Mot de passe oublié ?”.", "err");
      }

      setLoading(true);
      showMsg("Envoi du lien de réinitialisation…", "info");

      const next = safeNext(getNext());

      const { error } = await supabase.auth.resetPasswordForEmail(email, {
        redirectTo: origin() + "/login.html?next=" + encodeURIComponent(next),
      });

      setLoading(false);
      if (error) return showMsg(error.message, "err");

      showMsg("Email envoyé. Vérifie ta boîte de réception (et indésirables).", "ok");
    });

    // Logout (box "déjà connecté")
    logoutBtn.addEventListener("click", async () => {
      clearMsg();
      setLoading(true);
      showMsg("Déconnexion…", "info");

      const { error } = await supabase.auth.signOut();
      setLoading(false);

      if (error) return showMsg(error.message, "err");

      setAlreadyConnectedUI(false);
      showMsg("Déconnectée.", "ok");
    });

    // ✅ IMPORTANT: on garde onAuthStateChange seulement pour UI (PAS de redirect)
    supabase.auth.onAuthStateChange((event, session) => {
      if (session) {
        setAlreadyConnectedUI(true);
        setLoading(false);
      } else {
        setAlreadyConnectedUI(false);
      }
    });
  })();
</script>
