<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Luna Astralis — Créer un compte</title>
    <meta name="description" content="Créer un compte Luna Astralis." />

    <link rel="stylesheet" href="./css/styles.css" />
    <link rel="stylesheet" href="./css/auth.css" />
  </head>

  <body class="auth-body">
    <header class="top" role="banner">
      <a class="brand" href="./index.html" aria-label="Accueil Luna Astralis">
        <div class="logo" aria-hidden="true">
          <img src="./logo-luna-astralis-transparent.png" alt="" />
        </div>

        <div class="brand-text">
          <div class="brand-name">LUNA ASTRALIS</div>
          <div class="brand-sub">Astro & psycho</div>
        </div>
      </a>

      <nav class="nav" aria-label="Navigation">
        <a class="btn btn-small btn-ghost" id="loginLink" href="./login.html">Mon compte</a>
      </nav>
    </header>

    <main class="wrap auth-wrap" role="main">
      <section class="auth-card" aria-label="Créer un compte">
        <h1 class="auth-title">Créer un compte</h1>
        <p class="auth-sub">
          Sauvegarde tes échanges et continue après les messages gratuits.
        </p>

        <!-- message -->
        <div
          id="msg"
          class="auth-msg"
          role="status"
          aria-live="polite"
          style="display:none;"
        ></div>

        <!-- Déjà connecté (affiché seulement si session existe) -->
        <div id="already" style="display:none; margin-top:12px;">
          <p class="auth-sub" style="margin:0 0 10px 0;">
            Tu es déjà connectée.
          </p>
          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <a class="btn" id="goNextBtn" href="./chat.html">Continuer</a>
            <a class="btn btn-ghost" id="goAccountBtn" href="./login.html">Mon compte</a>
            <button type="button" class="btn btn-ghost" id="logoutBtn">Se déconnecter</button>
          </div>
          <div class="auth-sep" aria-hidden="true" style="margin-top:14px;"><span>ou</span></div>
        </div>

        <!-- Google -->
        <button type="button" class="btn auth-google" id="googleSignup">
          <img src="./google-g.png" alt="" class="google-icon" aria-hidden="true" />
          Continuer avec Google
        </button>

        <div class="auth-sep" aria-hidden="true"><span>ou</span></div>

        <!-- Email / password -->
        <form class="auth-form" id="signupForm" autocomplete="on" novalidate>
          <label class="auth-label" for="email">Email</label>
          <input
            class="auth-input"
            id="email"
            name="email"
            type="email"
            placeholder="ex. toi@email.com"
            required
            autocomplete="email"
            inputmode="email"
          />

          <label class="auth-label" for="password">Mot de passe</label>
          <input
            class="auth-input"
            id="password"
            name="password"
            type="password"
            placeholder="Minimum 8 caractères"
            minlength="8"
            required
            autocomplete="new-password"
          />

          <button class="btn auth-submit" id="submitBtn" type="submit">
            Créer mon compte
          </button>

          <p class="auth-legal">
            En créant un compte, tu acceptes que cet outil soit une exploration
            personnelle (non thérapeutique) et ne remplace pas un professionnel.
          </p>

          <p class="auth-switch">
            Déjà un compte ?
            <a class="auth-link" id="loginLink2" href="./login.html">Se connecter</a>
          </p>
        </form>
      </section>
    </main>

    <!-- Supabase JS (UMD v2) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
      (function () {
        /* =========================
           SUPABASE (1 seul client)
        ========================= */
        const SUPABASE_URL = "https://auxhexhkrfyizqjvnpvn.supabase.co";
        const SUPABASE_KEY = "sb_publishable_jSrj1sEIrDuu73hJHhrnXw_vK7mlQeg";

        const supabase =
          window.__LA_SUPABASE__ ||
          (window.__LA_SUPABASE__ = window.supabase.createClient(
            SUPABASE_URL,
            SUPABASE_KEY
          ));

        /* =========================
           UI helpers
        ========================= */
        const msgEl = document.getElementById("msg");
        const submitBtn = document.getElementById("submitBtn");
        const googleBtn = document.getElementById("googleSignup");
        const form = document.getElementById("signupForm");

        const alreadyBox = document.getElementById("already");
        const goNextBtn = document.getElementById("goNextBtn");
        const goAccountBtn = document.getElementById("goAccountBtn");
        const logoutBtn = document.getElementById("logoutBtn");

        function showMsg(text, type = "info") {
          msgEl.style.display = "block";
          msgEl.textContent = text;
          msgEl.classList.remove("is-ok", "is-err", "is-info");
          msgEl.classList.add(
            type === "ok" ? "is-ok" : type === "err" ? "is-err" : "is-info"
          );
        }
        function clearMsg() {
          msgEl.style.display = "none";
          msgEl.textContent = "";
          msgEl.classList.remove("is-ok", "is-err", "is-info");
        }
        function setLoading(v) {
          submitBtn.disabled = v;
          googleBtn.disabled = v;
          submitBtn.style.opacity = v ? "0.7" : "1";
          googleBtn.style.opacity = v ? "0.7" : "1";
        }

        function origin() {
          return window.location.origin;
        }

        function getNext() {
          const p = new URLSearchParams(location.search).get("next");
          return p && p.trim() ? p.trim() : "chat.html";
        }

        function safeNext(next) {
          if (
            !next ||
            next.includes("http://") ||
            next.includes("https://") ||
            next.startsWith("//")
          ) {
            return "chat.html";
          }
          return next.replace(/^\//, "");
        }

        function nextUrl() {
          return "./" + safeNext(getNext());
        }

        function setAlreadyConnectedUI(isConnected) {
          alreadyBox.style.display = isConnected ? "block" : "none";
          if (isConnected) {
            goNextBtn.href = nextUrl();
            // ramène vers login (mon compte) en gardant next
            const nextEnc = encodeURIComponent(safeNext(getNext()));
            goAccountBtn.href = "./login.html?next=" + nextEnc;
          }
        }

        // injecter next dans les liens vers login
        const nextEnc = encodeURIComponent(safeNext(getNext()));
        document.getElementById("loginLink").href = "./login.html?next=" + nextEnc;
        document.getElementById("loginLink2").href = "./login.html?next=" + nextEnc;

        /* =========================
           ✅ IMPORTANT: PAS DE REDIRECTION AUTO
           On affiche juste l'état "déjà connectée"
        ========================= */
        (async () => {
          try {
            const { data } = await supabase.auth.getSession();
            if (data?.session) {
              setAlreadyConnectedUI(true);
              showMsg("Tu es déjà connectée.", "ok");
            } else {
              setAlreadyConnectedUI(false);
            }
          } catch (_) {}
        })();

        /* =========================
           Signup email/password
           ✅ redirection seulement si session immédiate
        ========================= */
        form.addEventListener("submit", async (e) => {
          e.preventDefault();
          clearMsg();

          const email = document.getElementById("email").value.trim();
          const password = document.getElementById("password").value;

          if (!email || !email.includes("@")) return showMsg("Entre un email valide.", "err");
          if (!password || password.length < 8)
            return showMsg("Mot de passe : minimum 8 caractères.", "err");

          setLoading(true);
          showMsg("Création du compte…", "info");

          const next = safeNext(getNext());

          const { data, error } = await supabase.auth.signUp({
            email,
            password,
            options: {
              // Après confirmation email: on repasse par login avec next
              emailRedirectTo: origin() + "/login.html?next=" + encodeURIComponent(next),
            },
          });

          if (error) {
            setLoading(false);
            return showMsg(error.message, "err");
          }

          // Si confirmation email désactivée => session immédiate
          if (data?.session) {
            showMsg("Compte créé. Redirection…", "ok");
            window.location.href = nextUrl();
            return;
          }

          // Sinon: email de confirmation requis
          setLoading(false);
          showMsg(
            "Compte créé ! Vérifie ton email pour confirmer, puis reviens te connecter.",
            "ok"
          );
        });

        /* =========================
           Google OAuth
           ✅ revenir sur login.html?next=...
        ========================= */
        googleBtn.addEventListener("click", async () => {
          clearMsg();
          setLoading(true);
          showMsg("Ouverture de Google…", "info");

          const next = safeNext(getNext());

          const { error } = await supabase.auth.signInWithOAuth({
            provider: "google",
            options: {
              redirectTo: origin() + "/login.html?next=" + encodeURIComponent(next),
            },
          });

          if (error) {
            setLoading(false);
            showMsg(error.message, "err");
          }
        });

        /* =========================
           Logout (si déjà connecté)
        ========================= */
        logoutBtn.addEventListener("click", async () => {
          clearMsg();
          setLoading(true);
          showMsg("Déconnexion…", "info");
          const { error } = await supabase.auth.signOut();
          setLoading(false);

          if (error) return showMsg(error.message, "err");

          setAlreadyConnectedUI(false);
          showMsg("Déconnectée.", "ok");
        });

        /* =========================
           Auth state change:
           ✅ pas de "bang" redirect.
           On met juste l'UI à jour.
        ========================= */
        supabase.auth.onAuthStateChange((event, session) => {
          if (session) {
            setAlreadyConnectedUI(true);
            setLoading(false);
          } else {
            setAlreadyConnectedUI(false);
          }
        });
      })();
    </script>
  </body>
</html>
