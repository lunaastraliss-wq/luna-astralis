<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Luna Astralis — Créer un compte</title>
    <meta name="description" content="Créer un compte Luna Astralis." />

    <link rel="stylesheet" href="./css/styles.css" />
    <link rel="stylesheet" href="./css/auth.css" />
  </head>

  <body class="auth-body">
    <header class="top" role="banner">
      <a class="brand" href="./index.html" aria-label="Accueil Luna Astralis">
        <div class="logo" aria-hidden="true">
          <img src="./logo-luna-astralis-transparent.png" alt="" />
        </div>

        <div class="brand-text">
          <div class="brand-name">LUNA ASTRALIS</div>
          <div class="brand-sub">Astro & psycho</div>
        </div>
      </a>

      <nav class="nav" aria-label="Navigation">
        <a class="btn btn-small btn-ghost" href="./login.html">Mon compte</a>
      </nav>
    </header>

    <main class="wrap auth-wrap" role="main">
      <section class="auth-card" aria-label="Créer un compte">
        <h1 class="auth-title">Créer un compte</h1>
        <p class="auth-sub">
          Sauvegarde tes échanges et continue après les messages gratuits.
        </p>

        <!-- Message zone -->
        <div
          id="msg"
          class="auth-msg"
          role="status"
          aria-live="polite"
          style="display: none"
        ></div>

        <!-- Google -->
        <button type="button" class="btn auth-google" id="googleSignup">
          <img
            src="./google-g.png"
            alt=""
            class="google-icon"
            aria-hidden="true"
          />
          Continuer avec Google
        </button>

        <div class="auth-sep" aria-hidden="true">
          <span>ou</span>
        </div>

        <!-- Email / password -->
        <form class="auth-form" id="signupForm" autocomplete="on" novalidate>
          <label class="auth-label" for="email">Email</label>
          <input
            class="auth-input"
            id="email"
            name="email"
            type="email"
            placeholder="ex. toi@email.com"
            required
            autocomplete="email"
            inputmode="email"
          />

          <label class="auth-label" for="password">Mot de passe</label>
          <input
            class="auth-input"
            id="password"
            name="password"
            type="password"
            placeholder="Minimum 8 caractères"
            minlength="8"
            required
            autocomplete="new-password"
          />

          <button class="btn auth-submit" id="submitBtn" type="submit">
            Créer mon compte
          </button>

          <p class="auth-legal">
            En créant un compte, tu acceptes que cet outil soit une exploration
            personnelle (non thérapeutique) et ne remplace pas un professionnel.
          </p>

          <p class="auth-switch">
            Déjà un compte ?
            <a class="auth-link" href="./login.html">Se connecter</a>
          </p>
        </form>
      </section>
    </main>

    <!-- Supabase JS (UMD v2) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
      /* =========================================================
         CONFIG — mets TES valeurs (Publishable / anon-like)
         ========================================================= */
      const SUPABASE_URL = "https://TON-PROJECT-REF.supabase.co";
      const SUPABASE_PUBLISHABLE_KEY = "TON_PUBLISHABLE_KEY";

      // IMPORTANT:
      // - Utilise la "Publishable key" (pas la secret)
      // - Ton SUPABASE_URL doit finir par .supabase.co

      /* =========================================================
         UI helpers
         ========================================================= */
      const msgEl = document.getElementById("msg");
      const submitBtn = document.getElementById("submitBtn");
      const googleBtn = document.getElementById("googleSignup");

      function showMsg(text, type = "info") {
        msgEl.style.display = "block";
        msgEl.textContent = text;

        msgEl.classList.remove("is-ok", "is-err", "is-info");
        msgEl.classList.add(
          type === "ok" ? "is-ok" : type === "err" ? "is-err" : "is-info"
        );
      }

      function clearMsg() {
        msgEl.style.display = "none";
        msgEl.textContent = "";
        msgEl.classList.remove("is-ok", "is-err", "is-info");
      }

      function setLoading(isLoading) {
        submitBtn.disabled = isLoading;
        googleBtn.disabled = isLoading;
        submitBtn.style.opacity = isLoading ? "0.7" : "1";
        googleBtn.style.opacity = isLoading ? "0.7" : "1";
      }

      function origin() {
        return window.location.origin; // https://www.luna-astralis.app OU https://luna-astralis.app
      }

      function normalizeConfigOrFail() {
        if (!SUPABASE_URL || !SUPABASE_PUBLISHABLE_KEY) {
          showMsg(
            "Config Supabase manquante: ajoute SUPABASE_URL et SUPABASE_PUBLISHABLE_KEY.",
            "err"
          );
          return false;
        }
        if (!SUPABASE_URL.startsWith("https://") || !SUPABASE_URL.includes(".supabase.co")) {
          showMsg("SUPABASE_URL invalide (doit être https://xxxx.supabase.co).", "err");
          return false;
        }
        if (SUPABASE_PUBLISHABLE_KEY.length < 20) {
          showMsg("Clé Supabase invalide (publishable key).", "err");
          return false;
        }
        return true;
      }

      /* =========================================================
         Supabase client
         ========================================================= */
      const supabase = window.supabase.createClient(
        SUPABASE_URL,
        SUPABASE_PUBLISHABLE_KEY
      );

      /* =========================================================
         Optionnel: si déjà connecté -> chat
         ========================================================= */
      (async () => {
        if (!normalizeConfigOrFail()) return;

        try {
          const { data, error } = await supabase.auth.getSession();
          if (error) return;
          if (data?.session) window.location.href = "./chat.html";
        } catch (_) {}
      })();

      /* =========================================================
         Signup email/password
         ========================================================= */
      document.getElementById("signupForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        clearMsg();

        if (!normalizeConfigOrFail()) return;

        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value;

        // validations simples
        if (!email || !email.includes("@")) {
          showMsg("Entre un email valide.", "err");
          return;
        }
        if (!password || password.length < 8) {
          showMsg("Mot de passe : minimum 8 caractères.", "err");
          return;
        }

        setLoading(true);
        showMsg("Création du compte…", "info");

        try {
          // IMPORTANT:
          // emailRedirectTo doit être autorisé dans Supabase:
          // Auth > URL Configuration > Redirect URLs
          const { data, error } = await supabase.auth.signUp({
            email,
            password,
            options: {
              emailRedirectTo: origin() + "/login.html",
            },
          });

          if (error) {
            showMsg(error.message, "err");
            setLoading(false);
            return;
          }

          // Si confirmation email désactivée -> session directe
          if (data?.session) {
            showMsg("Compte créé. Redirection…", "ok");
            window.location.href = "./chat.html";
            return;
          }

          // Si confirmation email activée
          showMsg(
            "Compte créé ! Vérifie tes emails pour confirmer, puis connecte-toi.",
            "ok"
          );
          setLoading(false);
        } catch (err) {
          console.error(err);
          showMsg("Erreur inattendue. Réessaie.", "err");
          setLoading(false);
        }
      });

      /* =========================================================
         Google OAuth signup
         ========================================================= */
      document.getElementById("googleSignup").addEventListener("click", async () => {
        clearMsg();
        if (!normalizeConfigOrFail()) return;

        setLoading(true);
        showMsg("Ouverture de Google…", "info");

        try {
          const { error } = await supabase.auth.signInWithOAuth({
            provider: "google",
            options: {
              redirectTo: origin() + "/chat.html",
            },
          });

          if (error) {
            showMsg(error.message, "err");
            setLoading(false);
          }
          // sinon, redirection automatique vers Google
        } catch (err) {
          console.error(err);
          showMsg("Erreur Google. Réessaie.", "err");
          setLoading(false);
        }
      });
    </script>
  </body>
</html>
