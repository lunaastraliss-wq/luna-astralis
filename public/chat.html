<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Luna Astralis — Chat</title>
    <meta name="description" content="Chat Luna Astralis — Astro & psycho" />

    <link rel="stylesheet" href="./css/styles.css" />
    <link rel="stylesheet" href="./css/chat.css" />

    <!-- ✅ CSS temporaire seulement pour le “panel fixe / scroll interne”.
         (Ton vrai CSS est déjà ailleurs; garde ceci si tu veux le fix “panel ne grandit jamais”.) -->
    <style>
      html, body { height: 100%; }
      body.chat-body { height: 100%; overflow: hidden; }
      .chat-wrap { min-height: 0; }

      .chat-panel{
        display:flex;
        flex-direction:column;
        min-height:0;
        position:relative;
      }

      .chat-messages{
        flex:1;
        min-height:0;
        overflow-y:auto;
        overscroll-behavior: contain;
        scroll-behavior: smooth;
        padding-bottom: 12px;
      }

      .chat-inputbar{
        position: sticky;
        bottom: 0;
        z-index: 10;
        backdrop-filter: blur(6px);
      }

      .to-bottom{
        position: absolute;
        right: 12px;
        bottom: 70px;
        z-index: 20;
        display:none;
      }
      .to-bottom .to-bottom-btn{
        appearance:none;
        border: 1px solid rgba(255,255,255,.16);
        background: rgba(15,18,32,.92);
        color: rgba(255,255,255,.92);
        padding: 10px 12px;
        border-radius: 999px;
        cursor:pointer;
        font-size: 13px;
        box-shadow: 0 18px 40px rgba(0,0,0,.45);
      }
      .to-bottom .to-bottom-btn:hover{ filter: brightness(1.06); }

      .history{
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 18px;
        background: rgba(0,0,0,.75);
        backdrop-filter: blur(10px);
        z-index: 99999;
      }
      .history-card{
        width: min(760px, 100%);
        max-height: min(78vh, 740px);
        border-radius: 22px;
        overflow: hidden;
        border: 1px solid rgba(255,255,255,.14);
        background: rgba(10,12,24,.98);
        box-shadow: 0 25px 80px rgba(0,0,0,.65);
        color: rgba(255,255,255,.92);
        display:flex;
        flex-direction:column;
      }
      .history-top{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:12px;
        padding: 14px 14px;
        border-bottom: 1px solid rgba(255,255,255,.10);
        background: rgba(14,16,30,.98);
      }
      .history-title{
        font-weight: 1000;
        font-size: 14px;
        letter-spacing: .02em;
      }
      .history-close{
        appearance:none;
        border:1px solid rgba(255,255,255,.14);
        background: rgba(255,255,255,.06);
        color: rgba(255,255,255,.92);
        padding: 10px 12px;
        border-radius: 14px;
        cursor:pointer;
        font-weight: 900;
        font-size: 12px;
      }
      .history-close:hover{ background: rgba(255,255,255,.10); }
      .history-body{
        padding: 14px;
        overflow:auto;
        flex: 1;
      }
      .history-item{
        display:flex;
        gap: 10px;
        margin: 10px 0;
        align-items:flex-start;
      }
      .history-avatar{
        width: 34px;
        height: 34px;
        border-radius: 999px;
        object-fit: cover;
        object-position: 50% 18%;
        border: 1px solid rgba(255,255,255,.18);
        background: rgba(0,0,0,.25);
      }
      .history-bubble{
        max-width: 72ch;
        padding: 12px 14px;
        border-radius: 16px;
        border: 1px solid rgba(255,255,255,.12);
        background: rgba(255,255,255,.05);
        line-height: 1.45;
        white-space: pre-wrap;
      }
      .history-item.user{ justify-content:flex-end; }
      .history-item.user .history-bubble{
        background: rgba(146,112,255,.10);
        border-color: rgba(159,211,255,.14);
      }
      .history-foot{
        display:flex;
        gap:10px;
        flex-wrap: wrap;
        padding: 12px 14px;
        border-top: 1px solid rgba(255,255,255,.10);
        background: rgba(14,16,30,.98);
      }

      .paywall {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 18px;
        background: rgba(0,0,0,.55);
        backdrop-filter: blur(6px);
        z-index: 9999;
      }
      .paywall-card{
        width: min(520px, 100%);
        border-radius: 22px;
        padding: 18px 18px 16px;
        background: rgba(255,255,255,.08);
        border: 1px solid rgba(255,255,255,.14);
        box-shadow: 0 25px 70px rgba(0,0,0,.55);
        color: rgba(255,255,255,.92);
      }
      .paywall-title{ font-size: 18px; font-weight: 700; margin: 0 0 6px; }
      .paywall-desc{ margin: 0 0 14px; opacity: .85; line-height: 1.35; font-size: 14px; }
      .paywall-actions{ display:flex; gap:10px; flex-wrap:wrap; }
      .btn{
        appearance: none;
        border: 1px solid rgba(255,255,255,.18);
        background: rgba(255,255,255,.10);
        color: rgba(255,255,255,.92);
        padding: 10px 12px;
        border-radius: 14px;
        font-size: 14px;
        cursor: pointer;
        text-decoration: none;
        display:inline-flex;
        align-items:center;
        justify-content:center;
        gap:8px;
      }
      .btn:hover{ background: rgba(255,255,255,.14); }
      .btn-primary{
        background: rgba(215,199,255,.18);
        border-color: rgba(215,199,255,.28);
      }
      .btn-primary:hover{ background: rgba(215,199,255,.24); }
      .paywall-foot{ margin-top: 12px; font-size: 12px; opacity: .75; line-height: 1.35; }

      .mode-pill{
        display:inline-flex;
        align-items:center;
        gap:8px;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid rgba(255,255,255,.14);
        background: rgba(255,255,255,.06);
        font-size: 12px;
        opacity: .85;
      }
      .mode-dot{
        width:8px;height:8px;border-radius:999px;
        background: rgba(255,255,255,.75);
      }
      .mode-dot.green{ background: rgba(120,255,190,.85); }

      .input-disabled{ opacity:.6; pointer-events:none; }

      @media (max-width: 980px){
        body.chat-body{ overflow: auto; }
      }
    </style>
  </head>

  <body class="chat-body">
    <header class="chat-top" role="banner">
      <a class="chat-brand" href="./index.html" aria-label="Retour à l’accueil">
        <img class="chat-logo" src="./logo-luna-astralis-transparent.png" alt="Luna Astralis" />
        <div class="chat-brand-text">
          <div class="chat-brand-name">LUNA ASTRALIS</div>
          <div class="chat-brand-sub">Astro & psycho</div>
        </div>
      </a>

      <div style="display:flex; align-items:center; gap:14px;">
        <a class="chat-back" href="./index.html#signes">Changer de signe</a>

        <span class="mode-pill" id="modePill" title="Mode actuel">
          <span class="mode-dot" id="modeDot"></span>
          <span id="modeText">Invité</span>
        </span>

        <a class="chat-upgrade" href="#" id="upgradeLink" style="display:none;">Upgrade</a>
        <a class="chat-logout" href="#" id="logoutLink" style="display:none;">Déconnexion</a>
      </div>
    </header>

    <main class="chat-wrap" role="main">
      <aside class="chat-side" aria-label="Profil IA">
        <div class="ai-face-wrap">
          <img class="ai-face" src="./ia-luna-astralis.png" alt="Luna (IA)" />
        </div>

        <div>
          <div class="ai-name">Luna</div>
          <div class="ai-tag" id="aiTag">Signe : —</div>
          <div class="ai-desc" id="aiDesc">—</div>

          <div class="ai-book" id="aiBookWrap" style="display:none;">
            <a
              id="aiBookLink"
              class="ai-book-link"
              href="#"
              target="_blank"
              rel="noopener noreferrer"
              aria-label="Approfondir ce signe"
              title="Approfondir ce signe"
            >✦ Approfondir ce signe</a>
          </div>

          <div style="margin-top:10px; font-size:12px; opacity:.7;" id="userEmail"></div>
          <div style="margin-top:6px; font-size:12px; opacity:.7;" id="freeCounter"></div>
        </div>

        <div class="ai-disclaimer">
          Outil d’exploration personnelle, non thérapeutique. Aucune thérapie, aucun diagnostic.
        </div>
      </aside>

      <section class="chat-panel" aria-label="Discussion">
        <div class="chat-hero" aria-hidden="true">
          <div class="chat-hero-inner">
            <img class="chat-hero-img" src="./ia-luna-astralis.png" alt="" />
            <div class="chat-hero-overlay"></div>
            <div class="chat-hero-card">
              <p class="hero-title" id="heroTitle">—</p>
              <p class="hero-desc" id="heroDesc">—</p>
            </div>
          </div>
        </div>

        <div class="chat-header">
          <div class="chat-title">
            Discussion <span class="chat-pill" id="signLabel">—</span>
          </div>

          <div style="display:flex; align-items:center; gap:10px;">
            <button class="chat-history-btn" id="historyBtn" type="button">Historique</button>
            <div class="ai-face-mini-wrap" aria-hidden="true">
              <img class="ai-face-mini" src="./ia-luna-astralis.png" alt="" />
            </div>
          </div>
        </div>

        <div class="chat-messages" id="messages" role="log" aria-live="polite"></div>

        <div class="to-bottom" id="toBottomWrap">
          <button class="to-bottom-btn" id="toBottomBtn" type="button">⬇️ Aller en bas</button>
        </div>

        <form class="chat-inputbar" id="form" autocomplete="off">
          <input id="input" type="text" class="chat-input" placeholder="Écris ton message…" autocomplete="off" />
          <button class="chat-send" id="sendBtn" type="submit">Envoyer</button>
        </form>
      </section>
    </main>

    <!-- Paywall -->
    <div class="paywall" id="paywall">
      <div class="paywall-card" role="dialog" aria-modal="true" aria-label="Continuer la discussion">
        <h3 class="paywall-title">Continuer la discussion</h3>
        <p class="paywall-desc" id="paywallDesc">
          Tu as atteint la limite gratuite. Crée un compte (gratuit) pour continuer et retrouver tes échanges.
        </p>
        <div class="paywall-actions">
          <a class="btn btn-primary" id="paywallLogin" href="./login.html">Créer un compte / Se connecter</a>
          <a class="btn" id="paywallPricing" href="./pricing.html">Voir les offres</a>
          <button class="btn" id="paywallClose" type="button">Fermer</button>
        </div>
        <div class="paywall-foot">
          Astuce : tu peux démarrer en invité. Le compte sert à sauvegarder ton historique et débloquer plus de messages.
        </div>
      </div>
    </div>

    <!-- Historique -->
    <div class="history" id="history">
      <div class="history-card" role="dialog" aria-modal="true" aria-label="Historique">
        <div class="history-top">
          <div class="history-title">Historique</div>
          <button class="history-close" id="historyClose" type="button">Fermer</button>
        </div>
        <div class="history-body" id="historyBody"></div>
        <div class="history-foot">
          <button class="btn" id="historyScrollBottom" type="button">Aller au bas</button>
          <button class="btn btn-primary" id="historyClear" type="button">Effacer (local)</button>
        </div>
      </div>
    </div>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
      (function () {
        const SUPABASE_URL = "https://auxhexhkrfyizqjvnpvn.supabase.co";
        const SUPABASE_KEY = "sb_publishable_jSrj1sEIrDuu73hJHhrnXw_vK7mlQeg";

        const FREE_LIMIT = 15;
        const STORAGE_PREFIX = "la_chat_";
        const MAX_VISIBLE = 14;
        const CONTEXT_HISTORY = 8;

        if (!window.supabase || !window.supabase.createClient) {
          document.body.innerHTML =
            '<div style="padding:18px;color:#fff;font-family:system-ui">Erreur: Supabase JS non chargé (cdn).</div>';
          return;
        }

        // ✅ IMPORTANT: options auth pour que la session reste après signup/login
        const supabase =
          window.__LA_SUPABASE__ ||
          (window.__LA_SUPABASE__ = window.supabase.createClient(
            SUPABASE_URL,
            SUPABASE_KEY,
            {
              auth: {
                persistSession: true,
                autoRefreshToken: true,
                detectSessionInUrl: true,
                storage: window.localStorage,
              },
            }
          ));

        // DOM
        const messagesEl = document.getElementById("messages");
        const form = document.getElementById("form");
        const input = document.getElementById("input");
        const sendBtn = document.getElementById("sendBtn");

        const userEmailEl = document.getElementById("userEmail");
        const freeCounterEl = document.getElementById("freeCounter");

        const logoutLink = document.getElementById("logoutLink");
        const upgradeLink = document.getElementById("upgradeLink");

        const modeDot = document.getElementById("modeDot");
        const modeText = document.getElementById("modeText");

        const paywallEl = document.getElementById("paywall");
        const paywallDescEl = document.getElementById("paywallDesc");
        const paywallLogin = document.getElementById("paywallLogin");
        const paywallPricing = document.getElementById("paywallPricing");
        const paywallClose = document.getElementById("paywallClose");

        const toBottomWrap = document.getElementById("toBottomWrap");
        const toBottomBtn = document.getElementById("toBottomBtn");

        const historyEl = document.getElementById("history");
        const historyBtn = document.getElementById("historyBtn");
        const historyClose = document.getElementById("historyClose");
        const historyBody = document.getElementById("historyBody");
        const historyClear = document.getElementById("historyClear");
        const historyScrollBottom = document.getElementById("historyScrollBottom");

        if (!messagesEl) return;

        // Helpers URL
        function currentPathWithQuery() {
          const p = location.pathname.split("/").pop() || "chat.html";
          return p + location.search;
        }
        function loginUrl() {
          const next = encodeURIComponent(currentPathWithQuery());
          return "./login.html?next=" + next;
        }
        function pricingUrl() {
          const next = encodeURIComponent(currentPathWithQuery());
          return "./pricing.html?next=" + next;
        }

        // Query & signe
        const qs = (k) => new URLSearchParams(location.search).get(k) || "";
        const norm = (s) =>
          (s || "")
            .toLowerCase()
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .replace(/[^a-z]/g, "");

        const SIGNS = {
          belier: "Bélier ♈",
          taureau: "Taureau ♉",
          gemeaux: "Gémeaux ♊",
          cancer: "Cancer ♋",
          lion: "Lion ♌",
          vierge: "Vierge ♍",
          balance: "Balance ♎",
          scorpion: "Scorpion ♏",
          sagittaire: "Sagittaire ♐",
          capricorne: "Capricorne ♑",
          verseau: "Verseau ♒",
          poissons: "Poissons ♓",
        };

        const SIGN_DESC = {
          belier:
            "Énergie d’action et d’élan. On explore ton impulsion, ta colère (quand elle monte), et comment canaliser ton courage sans te brûler.",
          taureau:
            "Besoin de stabilité et de concret. On explore l’attachement, le plaisir, la sécurité intérieure, et comment lâcher sans perdre ton ancrage.",
          gemeaux:
            "Mental rapide et curiosité. On explore tes pensées en boucle, ta dualité, et comment clarifier ce que tu ressens derrière ce que tu analyses.",
          cancer:
            "Hyper-sensibilité et protection. On explore tes besoins affectifs, tes limites, et comment te sentir en sécurité sans tout porter seul·e.",
          lion:
            "Rayonnement et fierté du cœur. On explore l’estime de soi, la reconnaissance, et comment briller sans te suradapter au regard des autres.",
          vierge:
            "Lucidité et exigence. On explore le contrôle, la charge mentale, et comment trouver du calme quand tu veux que tout soit “bien fait”.",
          balance:
            "Équilibre et relation. On explore la peur du conflit, le besoin d’harmonie, et comment dire “non” sans culpabilité.",
          scorpion:
            "Intensité et transformation. On explore la confiance, la jalousie/la peur de perdre, et comment traverser une émotion sans te fermer.",
          sagittaire:
            "Sens et liberté. On explore l’ennui, l’envie d’ailleurs, et comment rester aligné·e quand tu te sens coincé·e ou limité·e.",
          capricorne:
            "Structure et responsabilité. On explore la pression, la performance, et comment te reposer sans te sentir “inutile”.",
          verseau:
            "Indépendance et vision. On explore la distance émotionnelle, ton besoin d’espace, et comment te connecter sans te sentir envahi·e.",
          poissons:
            "Intuition et empathie. On explore l’hypersensibilité, la fatigue émotionnelle, et comment te protéger sans t’éteindre.",
        };

        const SIGN_BOOKS = {
          belier: "https://a.co/d/ipv7KsG",
          taureau: "https://a.co/d/cNzESwI",
          gemeaux: "https://a.co/d/5rzhkCv",
          cancer: "https://a.co/d/9T3gj30",
          lion: "https://a.co/d/eQ0Fa2u",
          vierge: "https://a.co/d/7mMxP9f",
          balance: "https://a.co/d/i93cts5",
          scorpion: "https://a.co/d/0HQBCE8",
          sagittaire: "https://a.co/d/iOLDHqS",
          capricorne: "https://a.co/d/4JuWLu1",
          verseau: "https://a.co/d/de3Ukra",
          poissons: "https://a.co/d/hIM81yC",
        };

        const rawKey = qs("signe") || qs("sign") || "belier";
        const signKey = norm(rawKey) || "belier";
        const signName = SIGNS[signKey] || "—";
        const signDesc = SIGN_DESC[signKey] || "Exploration douce : émotions, relations, stress, schémas, besoins, limites.";

        const signLabelEl = document.getElementById("signLabel");
        const aiTagEl = document.getElementById("aiTag");
        const aiDescEl = document.getElementById("aiDesc");
        const heroTitleEl = document.getElementById("heroTitle");
        const heroDescEl = document.getElementById("heroDesc");

        if (signLabelEl) signLabelEl.textContent = signName;
        if (aiTagEl) aiTagEl.textContent = "Signe : " + signName;
        if (aiDescEl) aiDescEl.textContent = signDesc;
        if (heroTitleEl) heroTitleEl.textContent = "Ton signe : " + signName;
        if (heroDescEl) heroDescEl.textContent = signDesc;

        const bookUrl = SIGN_BOOKS[signKey];
        const wrap = document.getElementById("aiBookWrap");
        const link = document.getElementById("aiBookLink");
        if (wrap && link && bookUrl) {
          wrap.style.display = "block";
          link.href = bookUrl;
        }

        // Guest id
        const KEY_GUEST_ID = STORAGE_PREFIX + "guest_id";
        function getGuestId() {
          try {
            let id = localStorage.getItem(KEY_GUEST_ID);
            if (!id) {
              id =
                (crypto && crypto.randomUUID && crypto.randomUUID()) ||
                ("guest_" + Math.random().toString(36).slice(2) + Date.now());
              localStorage.setItem(KEY_GUEST_ID, id);
            }
            return id;
          } catch (_) {
            return "guest_" + Math.random().toString(36).slice(2) + Date.now();
          }
        }

        // Input enable/disable
        function setInputEnabled(enabled) {
          if (input) input.disabled = !enabled;
          if (sendBtn) sendBtn.disabled = !enabled;
          if (form) form.classList.toggle("input-disabled", !enabled);
        }

        // Scroll helpers
        function isNearBottom() {
          const threshold = 140;
          return messagesEl.scrollHeight - (messagesEl.scrollTop + messagesEl.clientHeight) < threshold;
        }
        function scrollToBottom(force) {
          if (force || isNearBottom()) {
            messagesEl.scrollTop = messagesEl.scrollHeight;
            if (toBottomWrap) toBottomWrap.style.display = "none";
          } else {
            if (toBottomWrap) toBottomWrap.style.display = "block";
          }
        }

        if (messagesEl) {
          messagesEl.addEventListener("scroll", () => {
            if (toBottomWrap) toBottomWrap.style.display = isNearBottom() ? "none" : "block";
          });
        }
        if (toBottomBtn) toBottomBtn.addEventListener("click", () => scrollToBottom(true));

        // Thread local (par signe)
        const KEY_THREAD = STORAGE_PREFIX + "thread_" + signKey;

        function loadThread() {
          try {
            const raw = localStorage.getItem(KEY_THREAD);
            const arr = raw ? JSON.parse(raw) : [];
            return Array.isArray(arr) ? arr : [];
          } catch (_) {
            return [];
          }
        }
        function saveThread(arr) {
          try { localStorage.setItem(KEY_THREAD, JSON.stringify(arr || [])); } catch (_) {}
        }

        // Render messages (tail only)
        function addMessage(role, text) {
          const row = document.createElement("div");
          row.className = "msg-row " + (role === "ai" ? "msg-ai" : "msg-user");

          if (role === "ai") {
            const avatar = document.createElement("img");
            avatar.className = "msg-avatar";
            avatar.src = "./ia-luna-astralis.png";
            avatar.alt = "Luna (IA)";
            row.appendChild(avatar);
          } else {
            const spacer = document.createElement("div");
            spacer.className = "msg-avatar-spacer";
            row.appendChild(spacer);
          }

          const bubble = document.createElement("div");
          bubble.className = "msg-bubble";
          bubble.textContent = text;

          row.appendChild(bubble);
          messagesEl.appendChild(row);

          while (messagesEl.children.length > MAX_VISIBLE) {
            messagesEl.removeChild(messagesEl.firstChild);
          }

          scrollToBottom(true);
          return row;
        }

        function replaceLastAiTyping(newText) {
          const last = messagesEl.querySelector(".msg-row.msg-ai:last-child .msg-bubble");
          if (last && last.textContent === "…") {
            last.textContent = newText;
            return true;
          }
          return false;
        }

        function renderThreadTail(thread) {
          messagesEl.innerHTML = "";
          const tail = (thread || []).slice(-MAX_VISIBLE);
          for (const m of tail) addMessage(m.role, m.text);
          scrollToBottom(true);
        }

        // Historique overlay
        function renderHistory(thread) {
          if (!historyBody) return;
          historyBody.innerHTML = "";
          for (const m of (thread || [])) {
            const item = document.createElement("div");
            item.className = "history-item " + (m.role === "user" ? "user" : "ai");

            if (m.role !== "user") {
              const av = document.createElement("img");
              av.className = "history-avatar";
              av.src = "./ia-luna-astralis.png";
              av.alt = "Luna (IA)";
              item.appendChild(av);
            } else {
              const spacer = document.createElement("div");
              spacer.style.width = "34px";
              spacer.style.height = "34px";
              item.appendChild(spacer);
            }

            const bubble = document.createElement("div");
            bubble.className = "history-bubble";
            bubble.textContent = m.text || "";
            item.appendChild(bubble);

            historyBody.appendChild(item);
          }
          historyBody.scrollTop = historyBody.scrollHeight;
        }

        function openHistory() {
          if (!historyEl) return;
          renderHistory(loadThread());
          historyEl.style.display = "flex";
          setInputEnabled(false);
        }
        function closeHistory() {
          if (!historyEl) return;
          historyEl.style.display = "none";
          setInputEnabled(true);
        }

        if (historyBtn) historyBtn.addEventListener("click", openHistory);
        if (historyClose) historyClose.addEventListener("click", closeHistory);
        if (historyEl) historyEl.addEventListener("click", (e) => { if (e.target === historyEl) closeHistory(); });
        if (historyScrollBottom) historyScrollBottom.addEventListener("click", () => { if (historyBody) historyBody.scrollTop = historyBody.scrollHeight; });
        if (historyClear) {
          historyClear.addEventListener("click", () => {
            try { localStorage.removeItem(KEY_THREAD); } catch(_){}
            bootGuest();
            renderHistory(loadThread());
          });
        }

        // Counter (guest only)
        const KEY_UI_USED = STORAGE_PREFIX + "ui_used_global";
        function getUiUsed() {
          const n = Number(localStorage.getItem(KEY_UI_USED) || "0");
          return Number.isFinite(n) ? n : 0;
        }
        function incUiUsed() {
          const n = getUiUsed() + 1;
          try { localStorage.setItem(KEY_UI_USED, String(n)); } catch (_) {}
          return n;
        }
        function updateFreeCounter(isAuth) {
          if (!freeCounterEl) return;
          if (isAuth) { freeCounterEl.textContent = ""; return; }
          const used = getUiUsed();
          const left = Math.max(0, FREE_LIMIT - used);
          freeCounterEl.textContent = left > 0
            ? `Gratuit : ${left} message(s) restant(s)`
            : `Limite gratuite atteinte`;
        }

        // Mode UI
        function setModeGuest() {
          if (modeText) modeText.textContent = "Invité";
          if (modeDot) modeDot.classList.remove("green");
          if (logoutLink) logoutLink.style.display = "none";
          if (upgradeLink) upgradeLink.style.display = "none";
          if (userEmailEl) userEmailEl.textContent = "";
          updateFreeCounter(false);
          setInputEnabled(true);
        }

        function setModeAuth(email) {
          if (modeText) modeText.textContent = "Connecté";
          if (modeDot) modeDot.classList.add("green");
          if (logoutLink) logoutLink.style.display = "inline";
          if (upgradeLink) upgradeLink.style.display = "inline";
          if (userEmailEl) userEmailEl.textContent = email || "";
          updateFreeCounter(true);
          setInputEnabled(true);
        }

        // Auth
        let SESSION = null;
        async function getSession() {
          try {
            const { data, error } = await supabase.auth.getSession();
            if (error) return null;
            return data?.session || null;
          } catch (_) {
            return null;
          }
        }

        // Paywall (sans doublons)
        async function openPaywall() {
          if (!paywallEl) return;

          if (paywallPricing) paywallPricing.style.display = "inline-flex";

          SESSION = await getSession();
          const isAuth = !!SESSION;
          const next = encodeURIComponent(currentPathWithQuery());

          if (isAuth) {
            if (paywallDescEl) paywallDescEl.textContent =
              "Tu as atteint la limite de ton forfait actuel. Choisis une offre pour continuer.";
            if (paywallLogin) {
              paywallLogin.textContent = "Voir les offres";
              paywallLogin.href = "./pricing.html?next=" + next;
            }
            if (paywallPricing) paywallPricing.style.display = "none";
          } else {
            if (paywallDescEl) paywallDescEl.textContent =
              "Tu as atteint la limite gratuite. Crée un compte (gratuit) pour continuer et retrouver tes échanges.";
            if (paywallLogin) {
              paywallLogin.textContent = "Créer un compte / Se connecter";
              paywallLogin.href = "./login.html?next=" + next;
            }
            if (paywallPricing) {
              paywallPricing.style.display = "inline-flex";
              paywallPricing.href = "./pricing.html?next=" + next;
            }
          }

          paywallEl.style.display = "flex";
          setInputEnabled(false);
        }

        function closePaywall() {
          if (!paywallEl) return;
          paywallEl.style.display = "none";
          setInputEnabled(true);
        }

        if (paywallClose) paywallClose.addEventListener("click", closePaywall);
        if (paywallEl) paywallEl.addEventListener("click", (e) => { if (e.target === paywallEl) closePaywall(); });

        // API call
        async function askLuna(userText, threadForContext, isAuth) {
          const payload = {
            message: userText,
            signKey,
            signName,
            signDesc,
            mode: isAuth ? "auth" : "guest",
            guestId: isAuth ? undefined : getGuestId(),
            history: (threadForContext || []).slice(-CONTEXT_HISTORY),
          };

          const res = await fetch("/api/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          const data = await res.json().catch(() => ({}));

          if (!res.ok) {
            if (data?.error === "FREE_LIMIT_REACHED") {
              await openPaywall();
              throw new Error("FREE_LIMIT_REACHED");
            }
            throw new Error(data?.error || "Erreur serveur (/api/chat).");
          }

          if (!data?.reply) throw new Error("Réponse vide.");
          return data.reply;
        }

        // Boot
        function bootGuest() {
          setModeGuest();
          const thread = loadThread();
          if (thread.length) {
            renderThreadTail(thread);
          } else {
            const hello =
              `Bonjour ✨\nAvec l’énergie de ton signe, ${signName}, on peut explorer ce que tu vis en ce moment.\nQu’est-ce qui te préoccupe aujourd’hui ?`;
            const t = [{ role: "ai", text: hello }];
            saveThread(t);
            renderThreadTail(t);
          }
        }

        function bootAuth(session) {
          const email = session.user?.email || "";
          setModeAuth(email);
          const thread = loadThread();
          if (thread.length) {
            renderThreadTail(thread);
          } else {
            const hello =
              `Bonjour ✨\nAvec l’énergie de ton signe, ${signName}, on peut explorer ce que tu vis en ce moment.\nQu’est-ce qui te préoccupe aujourd’hui ?`;
            const t = [{ role: "ai", text: hello }];
            saveThread(t);
            renderThreadTail(t);
          }
        }

        (async () => {
          SESSION = await getSession();
          if (!SESSION) {
            await new Promise(r => setTimeout(r, 300)); // petit délai post-login
            SESSION = await getSession();
          }
          if (SESSION) bootAuth(SESSION);
          else bootGuest();
        })();

        // Send
        if (form) {
          form.addEventListener("submit", async (e) => {
            e.preventDefault();

            const text = (input && input.value ? input.value : "").trim();
            if (!text) return;

            SESSION = await getSession();

            // GUEST
            if (!SESSION) {
              const usedUi = getUiUsed();
              if (usedUi >= FREE_LIMIT) {
                await openPaywall();
                updateFreeCounter(false);
                return;
              }

              const thread = loadThread();
              thread.push({ role: "user", text });
              saveThread(thread);

              addMessage("user", text);

              incUiUsed();
              updateFreeCounter(false);

              if (input) { input.value = ""; input.focus(); }

              addMessage("ai", "…");

              try {
                const reply = await askLuna(text, thread, false);
                replaceLastAiTyping(reply) || addMessage("ai", reply);

                const t2 = loadThread();
                t2.push({ role: "ai", text: reply });
                saveThread(t2);
              } catch (err) {
                if (err?.message === "FREE_LIMIT_REACHED") return;

                const msg =
                  "Erreur. Vérifie que /api/chat existe sur Vercel. " +
                  (err?.message ? ("(" + err.message + ")") : "");
                replaceLastAiTyping(msg) || addMessage("ai", msg);

                const t2 = loadThread();
                t2.push({ role: "ai", text: msg });
                saveThread(t2);
              }
              return;
            }

            // AUTH
            addMessage("user", text);

            const thread = loadThread();
            thread.push({ role: "user", text });
            saveThread(thread);

            if (input) { input.value = ""; input.focus(); }
            addMessage("ai", "…");

            try {
              const reply = await askLuna(text, thread, true);
              replaceLastAiTyping(reply) || addMessage("ai", reply);

              const t2 = loadThread();
              t2.push({ role: "ai", text: reply });
              saveThread(t2);
            } catch (err) {
              const msg =
                "Erreur. Vérifie que /api/chat existe sur Vercel. " +
                (err?.message ? ("(" + err.message + ")") : "");
              replaceLastAiTyping(msg) || addMessage("ai", msg);

              const t2 = loadThread();
              t2.push({ role: "ai", text: msg });
              saveThread(t2);
            }
          });
        }

        // Logout
        if (logoutLink) {
          logoutLink.addEventListener("click", async (e) => {
            e.preventDefault();
            await supabase.auth.signOut();
            SESSION = null;
            closePaywall();
            bootGuest();
          });
        }

        // Upgrade link
        if (upgradeLink) upgradeLink.href = pricingUrl();

        // Auth change
        supabase.auth.onAuthStateChange(async (event, session) => {
          SESSION = session || null;
          closePaywall();
          if (SESSION) bootAuth(SESSION);
          else bootGuest();
        });

        // Paywall fallback links
        if (paywallLogin) paywallLogin.href = loginUrl();
        if (paywallPricing) paywallPricing.href = pricingUrl();
      })();
    </script>
  </body>
</html>
