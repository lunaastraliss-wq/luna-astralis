<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Luna Astralis — Chat</title>
    <meta name="description" content="Chat Luna Astralis — Astro & psycho" />

    <link rel="stylesheet" href="./css/styles.css" />
    <link rel="stylesheet" href="./css/chat.css" />

    <style>
      /* =========================
         PETITS AJOUTS UI (performance + long chat)
      ========================= */

      /* Assure que le panel chat ne “grandit” pas et que le scroll reste DANS messages */
      .chat-panel{
        display:flex;
        flex-direction:column;
        min-height:0; /* important pour overflow */
      }
      .chat-messages{
        flex:1;
        min-height:0;
        overflow-y:auto;
        overscroll-behavior: contain;
        scroll-behavior: smooth;
        padding-bottom: 12px;
      }
      .chat-inputbar{
        position: sticky;
        bottom: 0;
        z-index: 10;
        backdrop-filter: blur(6px);
      }

      /* Charger plus (en haut du chat) */
      .chat-loadmore{
        position: sticky;
        top: 0;
        z-index: 9;
        display:none;
        padding: 10px 10px 0;
        background: linear-gradient(to bottom, rgba(6,8,21,.92), rgba(6,8,21,.55), rgba(6,8,21,0));
      }
      .chat-loadmore .btn-mini{
        width:100%;
        appearance:none;
        border: 1px solid rgba(255,255,255,.14);
        background: rgba(255,255,255,.06);
        color: rgba(255,255,255,.90);
        padding: 10px 12px;
        border-radius: 14px;
        font-size: 13px;
        cursor:pointer;
      }
      .chat-loadmore .btn-mini:hover{ background: rgba(255,255,255,.10); }

      /* Bouton “aller en bas” quand user a scroll up */
      .to-bottom{
        position: absolute;
        right: 12px;
        bottom: 70px; /* au-dessus de l’input */
        z-index: 20;
        display:none;
      }
      .to-bottom .to-bottom-btn{
        appearance:none;
        border: 1px solid rgba(255,255,255,.16);
        background: rgba(255,255,255,.10);
        color: rgba(255,255,255,.92);
        padding: 10px 12px;
        border-radius: 999px;
        cursor:pointer;
        font-size: 13px;
        box-shadow: 0 18px 40px rgba(0,0,0,.45);
      }
      .to-bottom .to-bottom-btn:hover{ background: rgba(255,255,255,.14); }

      /* Ton existant */
      .ai-book { margin-top: 10px; }
      .ai-book-link{
        display:inline-flex; align-items:center; gap:8px;
        font-size:12px; opacity:.65;
        text-decoration:underline; text-underline-offset:3px;
        color:rgba(255,255,255,.92);
      }
      .ai-book-link:hover{ opacity:.9; }

      .chat-logout{
        margin-left: 12px;
        font-size: 13px;
        opacity:.75;
        text-decoration: underline;
        text-underline-offset: 3px;
      }
      .chat-logout:hover{ opacity:1; }

      .chat-upgrade{
        margin-left: 10px;
        font-size: 13px;
        opacity: .9;
        text-decoration: underline;
        text-underline-offset: 3px;
      }
      .chat-upgrade:hover{ opacity:1; }

      /* ===== Paywall overlay (Replika-like) ===== */
      .paywall {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 18px;
        background: rgba(0,0,0,.55);
        backdrop-filter: blur(6px);
        z-index: 9999;
      }
      .paywall-card{
        width: min(520px, 100%);
        border-radius: 22px;
        padding: 18px 18px 16px;
        background: rgba(255,255,255,.08);
        border: 1px solid rgba(255,255,255,.14);
        box-shadow: 0 25px 70px rgba(0,0,0,.55);
        color: rgba(255,255,255,.92);
      }
      .paywall-title{
        font-size: 18px;
        font-weight: 700;
        margin: 0 0 6px;
        letter-spacing: .2px;
      }
      .paywall-desc{
        margin: 0 0 14px;
        opacity: .85;
        line-height: 1.35;
        font-size: 14px;
      }
      .paywall-actions{
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      .btn{
        appearance: none;
        border: 1px solid rgba(255,255,255,.18);
        background: rgba(255,255,255,.10);
        color: rgba(255,255,255,.92);
        padding: 10px 12px;
        border-radius: 14px;
        font-size: 14px;
        cursor: pointer;
        text-decoration: none;
        display:inline-flex;
        align-items:center;
        justify-content:center;
        gap:8px;
      }
      .btn:hover{ background: rgba(255,255,255,.14); }
      .btn-primary{
        background: rgba(215,199,255,.18);
        border-color: rgba(215,199,255,.28);
      }
      .btn-primary:hover{ background: rgba(215,199,255,.24); }
      .paywall-foot{
        margin-top: 12px;
        font-size: 12px;
        opacity: .75;
        line-height: 1.35;
      }

      .mode-pill{
        display:inline-flex;
        align-items:center;
        gap:8px;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid rgba(255,255,255,.14);
        background: rgba(255,255,255,.06);
        font-size: 12px;
        opacity: .85;
      }
      .mode-dot{
        width:8px;height:8px;border-radius:999px;
        background: rgba(255,255,255,.75);
      }
      .mode-dot.green{ background: rgba(120,255,190,.85); }

      /* petit état "bloqué" quand paywall */
      .input-disabled{
        opacity: .6;
        pointer-events: none;
      }
    </style>
  </head>

  <body class="chat-body">
    <header class="chat-top" role="banner">
      <a class="chat-brand" href="./index.html" aria-label="Retour à l’accueil">
        <img class="chat-logo" src="./logo-luna-astralis-transparent.png" alt="Luna Astralis" />
        <div class="chat-brand-text">
          <div class="chat-brand-name">LUNA ASTRALIS</div>
          <div class="chat-brand-sub">Astro & psycho</div>
        </div>
      </a>

      <div style="display:flex; align-items:center; gap:14px;">
        <a class="chat-back" href="./index.html#signes">Changer de signe</a>

        <span class="mode-pill" id="modePill" title="Mode actuel">
          <span class="mode-dot" id="modeDot"></span>
          <span id="modeText">Invité</span>
        </span>

        <a class="chat-upgrade" href="#" id="upgradeLink" style="display:none;">Upgrade</a>
        <a class="chat-logout" href="#" id="logoutLink" style="display:none;">Déconnexion</a>
      </div>
    </header>

    <main class="chat-wrap" role="main">
      <aside class="chat-side" aria-label="Profil IA">
        <div class="ai-face-wrap">
          <img class="ai-face" src="./ia-luna-astralis.png" alt="Luna (IA)" />
        </div>

        <div>
          <div class="ai-name">Luna</div>
          <div class="ai-tag" id="aiTag">Signe : —</div>
          <div class="ai-desc" id="aiDesc">—</div>

          <div class="ai-book" id="aiBookWrap" style="display:none;">
            <a
              id="aiBookLink"
              class="ai-book-link"
              href="#"
              target="_blank"
              rel="noopener noreferrer"
              aria-label="Approfondir ce signe"
              title="Approfondir ce signe"
            >
              ✦ Approfondir ce signe
            </a>
          </div>

          <div style="margin-top:10px; font-size:12px; opacity:.7;" id="userEmail"></div>
          <div style="margin-top:6px; font-size:12px; opacity:.7;" id="freeCounter"></div>
        </div>

        <div class="ai-disclaimer">
          Outil d’exploration personnelle, non thérapeutique. Aucune thérapie, aucun diagnostic.
        </div>
      </aside>

      <section class="chat-panel" aria-label="Discussion" style="position:relative;">
        <!-- HERO MOBILE -->
        <div class="chat-hero" aria-hidden="true">
          <div class="chat-hero-inner">
            <img class="chat-hero-img" src="./ia-luna-astralis.png" alt="" />
            <div class="chat-hero-overlay"></div>

            <div class="chat-hero-card">
              <p class="hero-title" id="heroTitle">—</p>
              <p class="hero-desc" id="heroDesc">—</p>
            </div>
          </div>
        </div>

        <div class="chat-header">
          <div class="chat-title">
            Discussion <span class="chat-pill" id="signLabel">—</span>
          </div>
          <div class="ai-face-mini-wrap" aria-hidden="true">
            <img class="ai-face-mini" src="./ia-luna-astralis.png" alt="" />
          </div>
        </div>

        <!-- Charger plus (sticky en haut de la zone messages) -->
        <div class="chat-loadmore" id="loadMoreWrap">
          <button class="btn-mini" id="loadMoreBtn" type="button">Charger les messages précédents</button>
        </div>

        <div class="chat-messages" id="messages" role="log" aria-live="polite"></div>

        <!-- Bouton aller en bas (quand on a scroll up) -->
        <div class="to-bottom" id="toBottomWrap">
          <button class="to-bottom-btn" id="toBottomBtn" type="button">⬇️ Aller en bas</button>
        </div>

        <form class="chat-inputbar" id="form" autocomplete="off">
          <input
            id="input"
            type="text"
            class="chat-input"
            placeholder="Écris ton message…"
            autocomplete="off"
          />
          <button class="chat-send" id="sendBtn" type="submit">Envoyer</button>
        </form>
      </section>
    </main>

    <!-- Paywall overlay -->
    <div class="paywall" id="paywall">
      <div class="paywall-card" role="dialog" aria-modal="true" aria-label="Continuer la discussion">
        <h3 class="paywall-title">Continuer la discussion</h3>
        <p class="paywall-desc" id="paywallDesc">
          Tu as atteint la limite gratuite. Crée un compte (gratuit) pour continuer et retrouver tes échanges.
        </p>
        <div class="paywall-actions">
          <a class="btn btn-primary" id="paywallLogin" href="./login.html">Créer un compte / Se connecter</a>
          <a class="btn" id="paywallPricing" href="./pricing.html">Voir les offres</a>
          <button class="btn" id="paywallClose" type="button">Fermer</button>
        </div>
        <div class="paywall-foot">
          Astuce : tu peux démarrer en invité. Le compte sert à sauvegarder ton historique et débloquer plus de messages.
        </div>
      </div>
    </div>

    <!-- Supabase JS (UMD v2) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
      (function () {
        /* =========================
           CONFIG
        ========================= */
        const SUPABASE_URL = "https://auxhexhkrfyizqjvnpvn.supabase.co";
        const SUPABASE_KEY = "sb_publishable_jSrj1sEIrDuu73hJHhrnXw_vK7mlQeg";

        const FREE_LIMIT = 15;
        const STORAGE_PREFIX = "la_chat_";

        /* PERF UI (important quand le chat grandit) */
        const RENDER_WINDOW = 60;  // nombre max de messages rendus (DOM)
        const LOAD_STEP = 30;      // combien on ajoute quand on “Charger plus”
        const CONTEXT_HISTORY = 6; // ce qu’on envoie à l’API (vitesse)

        /* =========================
           SAFE SUPABASE LOAD
        ========================= */
        if (!window.supabase || !window.supabase.createClient) {
          document.body.innerHTML =
            '<div style="padding:18px;color:#fff;font-family:system-ui">Erreur: Supabase JS non chargé (cdn). Vérifie le script supabase-js.</div>';
          return;
        }

        const supabase =
          window.__LA_SUPABASE__ ||
          (window.__LA_SUPABASE__ = window.supabase.createClient(
            SUPABASE_URL,
            SUPABASE_KEY
          ));

        /* =========================
           ELEMENTS
        ========================= */
        const messagesEl = document.getElementById("messages");
        const form = document.getElementById("form");
        const input = document.getElementById("input");
        const sendBtn = document.getElementById("sendBtn");

        const userEmailEl = document.getElementById("userEmail");
        const freeCounterEl = document.getElementById("freeCounter");

        const logoutLink = document.getElementById("logoutLink");
        const upgradeLink = document.getElementById("upgradeLink");

        const modeDot = document.getElementById("modeDot");
        const modeText = document.getElementById("modeText");

        const paywallEl = document.getElementById("paywall");
        const paywallLogin = document.getElementById("paywallLogin");
        const paywallPricing = document.getElementById("paywallPricing");
        const paywallClose = document.getElementById("paywallClose");

        const loadMoreWrap = document.getElementById("loadMoreWrap");
        const loadMoreBtn = document.getElementById("loadMoreBtn");

        const toBottomWrap = document.getElementById("toBottomWrap");
        const toBottomBtn = document.getElementById("toBottomBtn");

        if (!messagesEl) return;

        /* =========================
           URL helpers
        ========================= */
        function currentPathWithQuery() {
          const p = location.pathname.split("/").pop() || "chat.html";
          return p + location.search;
        }
        function loginUrl() {
          const next = encodeURIComponent(currentPathWithQuery());
          return "./login.html?next=" + next;
        }
        function pricingUrl() {
          const next = encodeURIComponent(currentPathWithQuery());
          return "./pricing.html?next=" + next;
        }

        /* =========================
           SIGN
        ========================= */
        const qs = (k) => new URLSearchParams(location.search).get(k) || "";
        const norm = (s) =>
          (s || "")
            .toLowerCase()
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .replace(/[^a-z]/g, "");

        const SIGNS = {
          belier: "Bélier ♈",
          taureau: "Taureau ♉",
          gemeaux: "Gémeaux ♊",
          cancer: "Cancer ♋",
          lion: "Lion ♌",
          vierge: "Vierge ♍",
          balance: "Balance ♎",
          scorpion: "Scorpion ♏",
          sagittaire: "Sagittaire ♐",
          capricorne: "Capricorne ♑",
          verseau: "Verseau ♒",
          poissons: "Poissons ♓",
        };

        const SIGN_DESC = {
          belier:
            "Énergie d’action et d’élan. On explore ton impulsion, ta colère (quand elle monte), et comment canaliser ton courage sans te brûler.",
          taureau:
            "Besoin de stabilité et de concret. On explore l’attachement, le plaisir, la sécurité intérieure, et comment lâcher sans perdre ton ancrage.",
          gemeaux:
            "Mental rapide et curiosité. On explore tes pensées en boucle, ta dualité, et comment clarifier ce que tu ressens derrière ce que tu analyses.",
          cancer:
            "Hyper-sensibilité et protection. On explore tes besoins affectifs, tes limites, et comment te sentir en sécurité sans tout porter seul·e.",
          lion:
            "Rayonnement et fierté du cœur. On explore l’estime de soi, la reconnaissance, et comment briller sans te suradapter au regard des autres.",
          vierge:
            "Lucidité et exigence. On explore le contrôle, la charge mentale, et comment trouver du calme quand tu veux que tout soit “bien fait”.",
          balance:
            "Équilibre et relation. On explore la peur du conflit, le besoin d’harmonie, et comment dire “non” sans culpabilité.",
          scorpion:
            "Intensité et transformation. On explore la confiance, la jalousie/la peur de perdre, et comment traverser une émotion sans te fermer.",
          sagittaire:
            "Sens et liberté. On explore l’ennui, l’envie d’ailleurs, et comment rester aligné·e quand tu te sens coincé·e ou limité·e.",
          capricorne:
            "Structure et responsabilité. On explore la pression, la performance, et comment te reposer sans te sentir “inutile”.",
          verseau:
            "Indépendance et vision. On explore la distance émotionnelle, ton besoin d’espace, et comment te connecter sans te sentir envahi·e.",
          poissons:
            "Intuition et empathie. On explore l’hypersensibilité, la fatigue émotionnelle, et comment te protéger sans t’éteindre.",
        };

        const SIGN_BOOKS = {
          belier: "https://a.co/d/ipv7KsG",
          taureau: "https://a.co/d/cNzESwI",
          gemeaux: "https://a.co/d/5rzhkCv",
          cancer: "https://a.co/d/9T3gj30",
          lion: "https://a.co/d/eQ0Fa2u",
          vierge: "https://a.co/d/7mMxP9f",
          balance: "https://a.co/d/i93cts5",
          scorpion: "https://a.co/d/0HQBCE8",
          sagittaire: "https://a.co/d/iOLDHqS",
          capricorne: "https://a.co/d/4JuWLu1",
          verseau: "https://a.co/d/de3Ukra",
          poissons: "https://a.co/d/hIM81yC",
        };

        const rawKey = qs("signe") || qs("sign") || "belier";
        const signKey = norm(rawKey) || "belier";
        const signName = SIGNS[signKey] || "—";
        const signDesc =
          SIGN_DESC[signKey] ||
          "Exploration douce : émotions, relations, stress, schémas, besoins, limites.";

        const signLabelEl = document.getElementById("signLabel");
        const aiTagEl = document.getElementById("aiTag");
        const aiDescEl = document.getElementById("aiDesc");
        const heroTitleEl = document.getElementById("heroTitle");
        const heroDescEl = document.getElementById("heroDesc");

        if (signLabelEl) signLabelEl.textContent = signName;
        if (aiTagEl) aiTagEl.textContent = "Signe : " + signName;
        if (aiDescEl) aiDescEl.textContent = signDesc;
        if (heroTitleEl) heroTitleEl.textContent = "Ton signe : " + signName;
        if (heroDescEl) heroDescEl.textContent = signDesc;

        const bookUrl = SIGN_BOOKS[signKey];
        const wrap = document.getElementById("aiBookWrap");
        const link = document.getElementById("aiBookLink");
        if (wrap && link && bookUrl) {
          wrap.style.display = "block";
          link.href = bookUrl;
        }

        /* =========================
           GUEST ID (limite serveur)
        ========================= */
        const KEY_GUEST_ID = STORAGE_PREFIX + "guest_id";
        function getGuestId() {
          try {
            let id = localStorage.getItem(KEY_GUEST_ID);
            if (!id) {
              id =
                (crypto && crypto.randomUUID && crypto.randomUUID()) ||
                ("guest_" + Math.random().toString(36).slice(2) + Date.now());
              localStorage.setItem(KEY_GUEST_ID, id);
            }
            return id;
          } catch (_) {
            return "guest_" + Math.random().toString(36).slice(2) + Date.now();
          }
        }

        /* =========================
           UI helpers
        ========================= */
        function setInputEnabled(enabled) {
          if (input) input.disabled = !enabled;
          if (sendBtn) sendBtn.disabled = !enabled;
          if (form) form.classList.toggle("input-disabled", !enabled);
        }

        /* =========================
           SCROLL helpers
        ========================= */
        function isNearBottom() {
          const threshold = 120; // px
          return messagesEl.scrollHeight - (messagesEl.scrollTop + messagesEl.clientHeight) < threshold;
        }
        function scrollToBottom(force) {
          if (force || isNearBottom()) {
            messagesEl.scrollTop = messagesEl.scrollHeight;
            if (toBottomWrap) toBottomWrap.style.display = "none";
          } else {
            if (toBottomWrap) toBottomWrap.style.display = "block";
          }
        }

        if (messagesEl) {
          messagesEl.addEventListener("scroll", () => {
            if (toBottomWrap) {
              toBottomWrap.style.display = isNearBottom() ? "none" : "block";
            }
          });
        }
        if (toBottomBtn) {
          toBottomBtn.addEventListener("click", () => scrollToBottom(true));
        }

        /* =========================
           CHAT RENDER (IMPORTANT)
           - on stocke tout en localStorage
           - mais on NE rend pas tout (DOM limité)
        ========================= */
        const KEY_THREAD = STORAGE_PREFIX + "thread_" + signKey;

        let THREAD = [];          // thread complet (storage)
        let renderStart = 0;      // index de départ de ce qu’on affiche

        function loadThread() {
          try {
            const raw = localStorage.getItem(KEY_THREAD);
            const arr = raw ? JSON.parse(raw) : [];
            return Array.isArray(arr) ? arr : [];
          } catch (_) {
            return [];
          }
        }
        function saveThread(arr) {
          try { localStorage.setItem(KEY_THREAD, JSON.stringify(arr || [])); } catch (_) {}
        }

        function clearMessagesDom() {
          messagesEl.innerHTML = "";
        }

        function addMessageDom(role, text) {
          const row = document.createElement("div");
          row.className = "msg-row " + (role === "ai" ? "msg-ai" : "msg-user");

          if (role === "ai") {
            const avatar = document.createElement("img");
            avatar.className = "msg-avatar";
            avatar.src = "./ia-luna-astralis.png";
            avatar.alt = "Luna (IA)";
            row.appendChild(avatar);
          } else {
            const spacer = document.createElement("div");
            spacer.className = "msg-avatar-spacer";
            row.appendChild(spacer);
          }

          const bubble = document.createElement("div");
          bubble.className = "msg-bubble";
          bubble.textContent = text;

          row.appendChild(bubble);
          messagesEl.appendChild(row);
          return row;
        }

        function renderThreadWindow({ preserveScroll } = { preserveScroll: false }) {
          // On rend seulement la fenêtre [renderStart .. end)
          const end = THREAD.length;
          const beforeHeight = messagesEl.scrollHeight;
          const beforeTop = messagesEl.scrollTop;

          clearMessagesDom();

          for (let i = renderStart; i < end; i++) {
            const m = THREAD[i];
            addMessageDom(m.role, m.text);
          }

          // load more visible ?
          const hasMore = renderStart > 0;
          if (loadMoreWrap) loadMoreWrap.style.display = hasMore ? "block" : "none";

          if (preserveScroll) {
            // préserver la position quand on précharge l’historique (sinon ça “saute”)
            const afterHeight = messagesEl.scrollHeight;
            const delta = afterHeight - beforeHeight;
            messagesEl.scrollTop = beforeTop + delta;
          } else {
            scrollToBottom(true);
          }
        }

        function ensureRenderWindowAtBottom() {
          // Toujours garder au moins les derniers RENDER_WINDOW
          renderStart = Math.max(0, THREAD.length - RENDER_WINDOW);
        }

        if (loadMoreBtn) {
          loadMoreBtn.addEventListener("click", () => {
            const nextStart = Math.max(0, renderStart - LOAD_STEP);
            if (nextStart === renderStart) return;
            renderStart = nextStart;
            renderThreadWindow({ preserveScroll: true });
          });
        }

        function pushToThread(role, text) {
          THREAD.push({ role, text });
          saveThread(THREAD);

          // si on est déjà sur la fin, on garde la fenêtre vers le bas
          const wasNearBottom = isNearBottom();

          // si ça dépasse la fenêtre, on décale le start (pour limiter DOM)
          ensureRenderWindowAtBottom();

          // rendu
          renderThreadWindow({ preserveScroll: false });

          // si l’utilisateur lisait plus haut, on ne force pas le scroll
          if (!wasNearBottom) {
            if (toBottomWrap) toBottomWrap.style.display = "block";
          } else {
            scrollToBottom(true);
          }
        }

        function replaceLastAiTyping(newText) {
          // Remplace le dernier bubble AI si c’est "…"
          const last = messagesEl.querySelector(".msg-row.msg-ai:last-child .msg-bubble");
          if (last && last.textContent === "…") {
            last.textContent = newText;
            return true;
          }
          return false;
        }

        /* =========================
           PAYWALL
        ========================= */
        function openPaywall() {
          if (!paywallEl) return;
          if (paywallLogin) paywallLogin.href = loginUrl();
          if (paywallPricing) paywallPricing.href = pricingUrl();
          paywallEl.style.display = "flex";
          setInputEnabled(false);
        }
        function closePaywall() {
          if (!paywallEl) return;
          paywallEl.style.display = "none";
          // On ne réactive que si utilisateur est connecté.
        }

        if (paywallClose) paywallClose.addEventListener("click", closePaywall);
        if (paywallEl) {
          paywallEl.addEventListener("click", (e) => {
            if (e.target === paywallEl) closePaywall();
          });
        }

        /* =========================
           COUNTER (UI indicatif) — GLOBAL
        ========================= */
        const KEY_UI_USED = STORAGE_PREFIX + "ui_used_global";

        function getUiUsed() {
          const n = Number(localStorage.getItem(KEY_UI_USED) || "0");
          return Number.isFinite(n) ? n : 0;
        }
        function incUiUsed() {
          const n = getUiUsed() + 1;
          try { localStorage.setItem(KEY_UI_USED, String(n)); } catch (_) {}
          return n;
        }
        function updateFreeCounter(isAuth) {
          if (!freeCounterEl) return;
          if (isAuth) { freeCounterEl.textContent = ""; return; }
          const used = getUiUsed();
          const left = Math.max(0, FREE_LIMIT - used);
          freeCounterEl.textContent =
            left > 0 ? `Gratuit : ${left} message(s) restant(s)` : `Limite gratuite atteinte`;
        }

        /* =========================
           MODE UI
        ========================= */
        function setModeGuest() {
          if (modeText) modeText.textContent = "Invité";
          if (modeDot) modeDot.classList.remove("green");
          if (logoutLink) logoutLink.style.display = "none";
          if (upgradeLink) upgradeLink.style.display = "none";
          if (userEmailEl) userEmailEl.textContent = "";
          updateFreeCounter(false);
          setInputEnabled(true);
        }

        function setModeAuth(email) {
          if (modeText) modeText.textContent = "Connecté";
          if (modeDot) modeDot.classList.add("green");
          if (logoutLink) logoutLink.style.display = "inline";
          if (upgradeLink) upgradeLink.style.display = "inline";
          if (userEmailEl) userEmailEl.textContent = email || "";
          updateFreeCounter(true);
          setInputEnabled(true);
        }

        /* =========================
           AUTH
        ========================= */
        let SESSION = null;

        async function getSession() {
          try {
            const { data, error } = await supabase.auth.getSession();
            if (error) return null;
            return data?.session || null;
          } catch (_) {
            return null;
          }
        }

        /* =========================
           API CALL
           NOTE: la “lenteur” ressentie vient surtout du temps modèle + réseau.
           Côté UI, on affiche "…" instantanément.
           Côté API, on envoie moins d’historique (CONTEXT_HISTORY) pour accélérer.
        ========================= */
        async function askLuna(userText, threadForContext, isAuth) {
          const payload = {
            message: userText,
            signKey,
            signName,
            signDesc,
            mode: isAuth ? "auth" : "guest",
            guestId: isAuth ? undefined : getGuestId(),
            history: (threadForContext || []).slice(-CONTEXT_HISTORY),
          };

          const controller = new AbortController();
          const timeout = setTimeout(() => controller.abort(), 25000); // 25s max

          let res;
          try {
            res = await fetch("/api/chat", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
              signal: controller.signal,
            });
          } finally {
            clearTimeout(timeout);
          }

          const data = await res.json().catch(() => ({}));

          if (!res.ok) {
            if (data?.error === "FREE_LIMIT_REACHED") {
              openPaywall();
              throw new Error("FREE_LIMIT_REACHED");
            }
            if (controller.signal.aborted) {
              throw new Error("TIMEOUT");
            }
            throw new Error(data?.error || "Erreur serveur (/api/chat).");
          }

          if (!data?.reply) throw new Error("Réponse vide.");
          return data.reply;
        }

        /* =========================
           BOOT
        ========================= */
        function ensureHelloIfEmpty() {
          if (THREAD.length) return;

          const hello =
            `Bonjour ✨\nAvec l’énergie de ton signe, ${signName}, on peut explorer ce que tu vis en ce moment.\nQu’est-ce qui te préoccupe aujourd’hui ?`;

          THREAD = [{ role: "ai", text: hello }];
          saveThread(THREAD);
        }

        function bootGuest() {
          setModeGuest();
          THREAD = loadThread();
          ensureHelloIfEmpty();
          ensureRenderWindowAtBottom();
          renderThreadWindow({ preserveScroll: false });
        }

        function bootAuth(session) {
          const email = session.user?.email || "";
          setModeAuth(email);

          THREAD = loadThread();
          ensureHelloIfEmpty();
          ensureRenderWindowAtBottom();
          renderThreadWindow({ preserveScroll: false });
        }

        (async () => {
          SESSION = await getSession();
          if (SESSION) bootAuth(SESSION);
          else bootGuest();
        })();

        /* =========================
           SEND
        ========================= */
        if (form) {
          form.addEventListener("submit", async (e) => {
            e.preventDefault();

            const text = (input && input.value ? input.value : "").trim();
            if (!text) return;

            SESSION = await getSession();

            // -------- GUEST --------
            if (!SESSION) {
              const usedUi = getUiUsed();
              if (usedUi >= FREE_LIMIT) {
                openPaywall();
                updateFreeCounter(false);
                return;
              }

              // UI: ajoute user + typing instant
              pushToThread("user", text);

              incUiUsed();
              updateFreeCounter(false);

              if (input) { input.value = ""; input.focus(); }

              // typing "…" (on l’ajoute seulement dans le DOM + thread)
              pushToThread("ai", "…");

              try {
                const reply = await askLuna(text, THREAD, false);

                // remplace "…" par la vraie réponse
                // 1) update thread (remplacer le dernier)
                if (THREAD.length && THREAD[THREAD.length - 1].role === "ai" && THREAD[THREAD.length - 1].text === "…") {
                  THREAD[THREAD.length - 1].text = reply;
                  saveThread(THREAD);
                  // 2) update DOM
                  replaceLastAiTyping(reply) || renderThreadWindow({ preserveScroll: false });
                } else {
                  pushToThread("ai", reply);
                }

              } catch (err) {
                if (err?.message === "FREE_LIMIT_REACHED") {
                  const msg = "Tu as atteint la limite gratuite. Crée un compte (gratuit) ou choisis une offre pour continuer.";
                  if (THREAD.length && THREAD[THREAD.length - 1].role === "ai" && THREAD[THREAD.length - 1].text === "…") {
                    THREAD[THREAD.length - 1].text = msg;
                    saveThread(THREAD);
                    replaceLastAiTyping(msg) || renderThreadWindow({ preserveScroll: false });
                  } else {
                    pushToThread("ai", msg);
                  }
                  updateFreeCounter(false);
                  return;
                }

                const msg =
                  err?.message === "TIMEOUT"
                    ? "La réponse prend trop de temps. Réessaie maintenant."
                    : ("Erreur. Vérifie /api/chat sur Vercel. " + (err?.message ? ("(" + err.message + ")") : ""));

                if (THREAD.length && THREAD[THREAD.length - 1].role === "ai" && THREAD[THREAD.length - 1].text === "…") {
                  THREAD[THREAD.length - 1].text = msg;
                  saveThread(THREAD);
                  replaceLastAiTyping(msg) || renderThreadWindow({ preserveScroll: false });
                } else {
                  pushToThread("ai", msg);
                }
              }

              return;
            }

            // -------- AUTH --------
            pushToThread("user", text);
            if (input) { input.value = ""; input.focus(); }

            pushToThread("ai", "…");

            try {
              const reply = await askLuna(text, THREAD, true);

              if (THREAD.length && THREAD[THREAD.length - 1].role === "ai" && THREAD[THREAD.length - 1].text === "…") {
                THREAD[THREAD.length - 1].text = reply;
                saveThread(THREAD);
                replaceLastAiTyping(reply) || renderThreadWindow({ preserveScroll: false });
              } else {
                pushToThread("ai", reply);
              }

            } catch (err) {
              const msg =
                err?.message === "TIMEOUT"
                  ? "La réponse prend trop de temps. Réessaie maintenant."
                  : ("Erreur. Vérifie /api/chat sur Vercel. " + (err?.message ? ("(" + err.message + ")") : ""));

              if (THREAD.length && THREAD[THREAD.length - 1].role === "ai" && THREAD[THREAD.length - 1].text === "…") {
                THREAD[THREAD.length - 1].text = msg;
                saveThread(THREAD);
                replaceLastAiTyping(msg) || renderThreadWindow({ preserveScroll: false });
              } else {
                pushToThread("ai", msg);
              }
            }
          });
        }

        /* =========================
           LOGOUT
        ========================= */
        if (logoutLink) {
          logoutLink.addEventListener("click", async (e) => {
            e.preventDefault();
            await supabase.auth.signOut();
            SESSION = null;
            closePaywall();
            bootGuest();
          });
        }

        /* =========================
           UPGRADE
        ========================= */
        if (upgradeLink) upgradeLink.href = pricingUrl();

        /* =========================
           Auth change
        ========================= */
        supabase.auth.onAuthStateChange(async (event, session) => {
          SESSION = session || null;
          closePaywall();
          if (SESSION) bootAuth(SESSION);
          else bootGuest();
        });

        // Liens paywall
        if (paywallLogin) paywallLogin.href = loginUrl();
        if (paywallPricing) paywallPricing.href = pricingUrl();
      })();
    </script>
  </body>
  </html>
