<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Luna Astralis — Tarifs</title>

    <meta
      name="description"
      content="Tarifs Luna Astralis — Astro & psycho. Accès 24h/7. Prix en dollars US."
    />

    <link rel="stylesheet" href="./css/styles.css" />
    <link rel="stylesheet" href="./css/pricing.css" />

    <style>
      /* Petit bloc message (optionnel) */
      .pricing-msg{
        margin: 14px 0 0;
        padding: 12px 14px;
        border-radius: 14px;
        border: 1px solid rgba(255,255,255,.14);
        background: rgba(255,255,255,.06);
        color: rgba(255,255,255,.92);
        line-height: 1.35;
        display:none;
      }
      .pricing-msg.is-ok{ background: rgba(120,255,190,.10); border-color: rgba(120,255,190,.22); }
      .pricing-msg.is-err{ background: rgba(255,90,90,.10); border-color: rgba(255,90,90,.22); }
      .pricing-msg.is-info{ background: rgba(159,211,255,.10); border-color: rgba(159,211,255,.22); }

      /* CTA loading */
      .price-cta[aria-busy="true"]{ opacity:.75; pointer-events:none; }
    </style>
  </head>

  <body class="pricing-body">
    <!-- HEADER -->
    <header class="top" role="banner">
      <a class="brand" href="./index.html" aria-label="Accueil Luna Astralis">
        <div class="logo" aria-hidden="true">
          <img src="./logo-luna-astralis-transparent.png" alt="" />
        </div>

        <div class="brand-text">
          <div class="brand-name">LUNA ASTRALIS</div>
          <div class="brand-sub">Astro & psycho</div>
        </div>
      </a>

      <nav class="nav" aria-label="Navigation principale">
        <a href="./index.html">Accueil</a>
        <a class="active" href="./pricing.html">Tarifs</a>
        <a class="btn btn-small btn-ghost" id="loginLink" href="./login.html">Connexion</a>
        <a class="btn btn-small" id="signupLink" href="./signup.html">Créer un compte</a>
      </nav>
    </header>

    <!-- MAIN -->
    <main class="wrap" role="main">
      <!-- HERO -->
      <section class="pricing-hero" aria-label="Présentation des tarifs">
        <div class="pricing-hero-inner">
          <div class="pricing-kicker">Accès 24h/7</div>
          <div class="pricing-kicker pricing-kicker-alt">TARIFS</div>

          <h1 class="pricing-title">Choisis le forfait qui te convient</h1>

          <p class="pricing-subtitle">
            Crée ton compte gratuitement, puis active un abonnement quand tu es prête.
          </p>

          <div class="pricing-chips" aria-label="Informations">
            <span class="chip">Prix en dollars US (USD)</span>
            <span class="chip">Annule ou change en tout temps</span>
          </div>

          <!-- Message status -->
          <div class="pricing-msg" id="msg" role="status" aria-live="polite"></div>
        </div>
      </section>

      <!-- Confiance -->
      <section class="section" aria-label="Confiance">
        <div class="pricing-trust">
          <div class="trust-line">
            ✦ Une expérience douce, inspirée de l’astrologie, pour mieux te comprendre.
          </div>
          <div class="trust-sub">
            Paiement sécurisé • Annulation en tout temps • Aucun frais caché
          </div>
        </div>
      </section>

      <!-- GRID -->
      <section class="section" aria-label="Formules">
        <div class="pricing-grid">
          <!-- Mensuel — Essentiel -->
          <article class="price-card" aria-label="Mensuel — Essentiel">
            <div class="price-head">
              <div class="price-name">Mensuel — Essentiel</div>
              <div class="price-value">
                <span class="price-now">4,99&nbsp;$</span>
                <span class="price-period">/ mois</span>
              </div>
              <div class="price-mini">Accès 24h/7</div>
            </div>

            <ul class="price-features">
              <li>100 messages / mois</li>
              <li>Tous les signes astrologiques</li>
              <li>Astro & psycho</li>
              <li>Compatible mobile</li>
            </ul>

            <!-- ✅ Stripe -->
            <button class="price-cta" data-plan="monthly_essential" type="button">
              Commencer
            </button>
          </article>

          <!-- Mensuel — Illimité -->
          <div class="price-halo" role="group" aria-label="Mensuel — Illimité (le plus populaire)">
            <article class="price-card price-featured" aria-label="Mensuel — Illimité">
              <div class="price-badge">LE PLUS POPULAIRE</div>

              <div class="price-head">
                <div class="price-name">Mensuel — Illimité</div>
                <div class="price-value">
                  <span class="price-now">9,99&nbsp;$</span>
                  <span class="price-period">/ mois</span>
                </div>
                <div class="price-mini">Accès 24h/7</div>
              </div>

              <ul class="price-features">
                <li>Messages illimités</li>
                <li>Tous les signes astrologiques</li>
                <li>Historique des conversations</li>
                <li>Exploration approfondie</li>
              </ul>

              <!-- ✅ Stripe -->
              <button class="price-cta btn-primary" data-plan="monthly_unlimited" type="button">
                Accès illimité 24h/7
              </button>
            </article>
          </div>

          <!-- Annuel — Essentiel -->
          <article class="price-card" aria-label="Annuel — Essentiel">
            <div class="price-head">
              <div class="price-name">Annuel — Essentiel</div>
              <div class="price-value">
                <span class="price-was"><s>59,99&nbsp;$</s></span>
                <span class="price-now">49,99&nbsp;$</span>
                <span class="price-period">/ an</span>
              </div>
              <div class="price-mini">
                Accès 24h/7 • <strong>Économisez 10&nbsp;$</strong>
              </div>
            </div>

            <ul class="price-features">
              <li>100 messages / mois</li>
              <li>Tous les signes astrologiques</li>
              <li>Astro & psycho</li>
              <li>Le plus économique</li>
            </ul>

            <!-- ✅ Stripe -->
            <button class="price-cta" data-plan="yearly_essential" type="button">
              Choisir l’annuel
            </button>
          </article>

          <!-- Annuel — Illimité -->
          <article class="price-card premium" aria-label="Annuel — Illimité">
            <div class="price-badge premium">MEILLEURE VALEUR</div>

            <div class="price-head">
              <div class="price-name">Annuel — Illimité</div>
              <div class="price-value">
                <span class="price-was"><s>119,99&nbsp;$</s></span>
                <span class="price-now">99,99&nbsp;$</span>
                <span class="price-period">/ an</span>
              </div>
              <div class="price-mini">
                Accès 24h/7 • <strong>Économisez 20&nbsp;$</strong>
              </div>
            </div>

            <ul class="price-features">
              <li>Messages illimités</li>
              <li>Tous les signes astrologiques</li>
              <li>Accès prioritaire</li>
              <li>Futur : Tarot, Lune, Ascendant</li>
            </ul>

            <!-- ✅ Stripe -->
            <button class="price-cta btn-primary" data-plan="yearly_unlimited" type="button">
              Accès illimité annuel
            </button>
          </article>
        </div>
      </section>

      <!-- FOOTER -->
      <footer class="footer" role="contentinfo">
        <div>© <span id="y"></span> Luna Astralis</div>
        <div class="footer-note">Prix en USD • Accès 24h/7</div>
      </footer>
    </main>

    <!-- Supabase (pour savoir si la personne est connectée) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
      document.getElementById("y").textContent = new Date().getFullYear();

      (function () {
        const SUPABASE_URL = "https://auxhexhkrfyizqjvnpvn.supabase.co";
        const SUPABASE_KEY = "sb_publishable_jSrj1sEIrDuu73hJHhrnXw_vK7mlQeg";

        const msgEl = document.getElementById("msg");

        function showMsg(text, type){
          if(!msgEl) return;
          msgEl.style.display = "block";
          msgEl.textContent = text;
          msgEl.classList.remove("is-ok","is-err","is-info");
          msgEl.classList.add(type === "ok" ? "is-ok" : type === "err" ? "is-err" : "is-info");
        }

        function currentPathWithQuery(){
          const p = location.pathname.split("/").pop() || "pricing.html";
          return p + location.search;
        }

        function safeNext(next){
          if(!next || next.includes("http://") || next.includes("https://") || next.startsWith("//")){
            return "pricing.html";
          }
          return next.replace(/^\//, "");
        }

        function loginUrl(){
          const next = encodeURIComponent(safeNext(currentPathWithQuery()));
          return "./login.html?next=" + next;
        }

        // Garder un “next” propre pour login / signup dans le header
        const loginLink = document.getElementById("loginLink");
        const signupLink = document.getElementById("signupLink");
        if(loginLink) loginLink.href = loginUrl();
        if(signupLink) signupLink.href = "./signup.html?next=" + encodeURIComponent(safeNext(currentPathWithQuery()));

        // Supabase client (session persistée)
        if (!window.supabase || typeof window.supabase.createClient !== "function") {
          showMsg("Supabase JS non chargé (CDN). Impossible de vérifier la session.", "err");
          return;
        }

        const supabase =
          window.__LA_SUPABASE__ ||
          (window.__LA_SUPABASE__ = window.supabase.createClient(
            SUPABASE_URL,
            SUPABASE_KEY,
            { auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true, storage: window.localStorage } }
          ));

        async function isLoggedIn(){
          try{
            const { data, error } = await supabase.auth.getSession();
            if(error) return false;
            return !!data?.session;
          }catch(_){
            return false;
          }
        }

        async function startCheckout(plan, btn){
          const logged = await isLoggedIn();
          if(!logged){
            // Ton /api/checkout exige un user authentifié → on force login
            window.location.href = loginUrl();
            return;
          }

          try{
            if(btn){
              btn.setAttribute("aria-busy","true");
              btn.textContent = "Redirection…";
            }
            showMsg("Ouverture de Stripe…", "info");

            const res = await fetch("/api/checkout", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ plan, lang: "fr" })
            });

            const data = await res.json().catch(() => ({}));
            if(!res.ok){
              throw new Error(data?.error || "Erreur checkout.");
            }
            if(!data?.url){
              throw new Error("URL Stripe manquante.");
            }

            window.location.href = data.url;
          }catch(err){
            if(btn){
              btn.removeAttribute("aria-busy");
              // remettre texte original selon plan
              const map = {
                monthly_essential: "Commencer",
                monthly_unlimited: "Accès illimité 24h/7",
                yearly_essential: "Choisir l’annuel",
                yearly_unlimited: "Accès illimité annuel"
              };
              btn.textContent = map[plan] || "Continuer";
            }
            showMsg("Erreur: " + (err?.message || String(err)), "err");
          }
        }

        // Canceled / paid messages
        const sp = new URLSearchParams(location.search);
        if(sp.get("canceled") === "1"){
          showMsg("Paiement annulé. Tu peux réessayer quand tu veux.", "info");
        }
        if(sp.get("paid") === "1"){
          showMsg("Paiement reçu. Merci ✨ Tu peux retourner au chat.", "ok");
        }

        // Bind buttons
        document.querySelectorAll("button.price-cta[data-plan]").forEach((btn) => {
          btn.addEventListener("click", () => {
            const plan = btn.getAttribute("data-plan");
            if(!plan) return;
            startCheckout(plan, btn);
          });
        });
      })();
    </script>
  </body>
</html>
