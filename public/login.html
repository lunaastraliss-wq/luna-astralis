<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Luna Astralis — Mon compte</title>
    <meta name="description" content="Connexion Luna Astralis." />

    <link rel="stylesheet" href="./css/styles.css" />
    <link rel="stylesheet" href="./css/auth.css" />
  </head>

  <body class="auth-body">
    <header class="top" role="banner">
      <a class="brand" href="./index.html" aria-label="Accueil Luna Astralis">
        <div class="logo" aria-hidden="true">
          <img src="./logo-luna-astralis-transparent.png" alt="" />
        </div>

        <div class="brand-text">
          <div class="brand-name">LUNA ASTRALIS</div>
          <div class="brand-sub">Astro & psycho</div>
        </div>
      </a>

      <nav class="nav" aria-label="Navigation">
        <a class="btn btn-small" id="signupLink" href="./signup.html">Créer un compte</a>
      </nav>
    </header>

    <main class="wrap auth-wrap" role="main">
      <section class="auth-card" aria-label="Connexion">
        <h1 class="auth-title">Mon compte</h1>
        <p class="auth-sub">
          Connecte-toi pour continuer la discussion et retrouver tes échanges.
        </p>

        <!-- message -->
        <div
          id="msg"
          class="auth-msg"
          role="status"
          aria-live="polite"
          style="display:none;"
        ></div>

        <!-- ✅ Déjà connecté -->
        <div id="already" style="display:none; margin-top:12px;">
          <p class="auth-sub" style="margin:0 0 10px 0;">
            Tu es déjà connectée.
          </p>
          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <a class="btn" id="goNextBtn" href="./chat.html">Continuer</a>
            <button type="button" class="btn btn-ghost" id="logoutBtn">Se déconnecter</button>
          </div>
          <div class="auth-sep" aria-hidden="true" style="margin-top:14px;"><span>ou</span></div>
        </div>

        <!-- Google -->
        <button type="button" class="btn auth-google" id="googleLogin">
          <img src="./google-g.png" alt="" class="google-icon" aria-hidden="true" />
          Continuer avec Google
        </button>

        <div class="auth-sep" aria-hidden="true"><span>ou</span></div>

        <!-- Email / password -->
        <form class="auth-form" id="loginForm" autocomplete="on" novalidate>
          <label class="auth-label" for="email">Email</label>
          <input
            class="auth-input"
            id="email"
            name="email"
            type="email"
            placeholder="ex. toi@email.com"
            required
            autocomplete="email"
            inputmode="email"
          />

          <label class="auth-label" for="password">Mot de passe</label>
          <input
            class="auth-input"
            id="password"
            name="password"
            type="password"
            placeholder="Ton mot de passe"
            required
            autocomplete="current-password"
          />

          <button class="btn auth-submit" id="submitBtn" type="submit">
            Se connecter
          </button>

          <button type="button" class="auth-forgot" id="forgot">
            Mot de passe oublié ?
          </button>

          <p class="auth-switch">
            Pas encore de compte ?
            <a class="auth-link" id="signupLink2" href="./signup.html">Créer un compte</a>
          </p>
        </form>
      </section>
    </main>

    <!-- Supabase JS (UMD v2) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
      window.addEventListener("DOMContentLoaded", function () {
        (function () {
          /* =========================
             SUPABASE (1 seul client)
          ========================= */
          const SUPABASE_URL = "https://auxhexhkrfyizqjvnpvn.supabase.co";
          const SUPABASE_KEY = "sb_publishable_jSrj1sEIrDuu73hJHhrnXw_vK7mlQeg";

          if (!window.supabase || typeof window.supabase.createClient !== "function") {
            const el = document.getElementById("msg");
            if (el) {
              el.style.display = "block";
              el.textContent =
                "Erreur: la librairie Supabase ne s'est pas chargée (CDN bloqué / offline).";
              el.classList.add("is-err");
            }
            return;
          }

          // ✅ Même config que chat.html (plus stable)
          const supabase =
            window.__LA_SUPABASE__ ||
            (window.__LA_SUPABASE__ = window.supabase.createClient(
              SUPABASE_URL,
              SUPABASE_KEY,
              {
                auth: {
                  persistSession: true,
                  autoRefreshToken: true,
                  detectSessionInUrl: true,
                  storage: window.localStorage,
                },
              }
            ));

          /* =========================
             DOM / UI
          ========================= */
          const msgEl = document.getElementById("msg");
          const submitBtn = document.getElementById("submitBtn");
          const googleBtn = document.getElementById("googleLogin");

          const alreadyBox = document.getElementById("already");
          const goNextBtn = document.getElementById("goNextBtn");
          const logoutBtn = document.getElementById("logoutBtn");

          const signup1 = document.getElementById("signupLink");
          const signup2 = document.getElementById("signupLink2");
          const loginForm = document.getElementById("loginForm");
          const forgotBtn = document.getElementById("forgot");

          const requiredEls = [
            ["#msg", msgEl],
            ["#submitBtn", submitBtn],
            ["#googleLogin", googleBtn],
            ["#already", alreadyBox],
            ["#goNextBtn", goNextBtn],
            ["#logoutBtn", logoutBtn],
            ["#signupLink", signup1],
            ["#signupLink2", signup2],
            ["#loginForm", loginForm],
            ["#forgot", forgotBtn],
          ];

          const missing = requiredEls.filter(([, el]) => !el).map(([id]) => id);
          if (missing.length) {
            const box = document.createElement("div");
            box.style.cssText =
              "max-width:820px;margin:16px auto;padding:14px;border:1px solid rgba(255,255,255,.22);border-radius:14px;color:#fff;background:rgba(255,0,0,.12);font-family:system-ui;line-height:1.35";
            box.textContent =
              "Erreur: éléments manquants dans le HTML: " + missing.join(", ");
            document.body.prepend(box);
            return;
          }

          function showMsg(text, type = "info") {
            msgEl.style.display = "block";
            msgEl.textContent = text;
            msgEl.classList.remove("is-ok", "is-err", "is-info");
            msgEl.classList.add(
              type === "ok" ? "is-ok" : type === "err" ? "is-err" : "is-info"
            );
          }
          function clearMsg() {
            msgEl.style.display = "none";
            msgEl.textContent = "";
            msgEl.classList.remove("is-ok", "is-err", "is-info");
          }
          function setLoading(v) {
            submitBtn.disabled = v;
            googleBtn.disabled = v;
            submitBtn.style.opacity = v ? "0.7" : "1";
            googleBtn.style.opacity = v ? "0.7" : "1";
          }

          function origin() {
            return window.location.origin;
          }

          function getNext() {
            const p = new URLSearchParams(location.search).get("next");
            return p && p.trim() ? p.trim() : "chat.html";
          }

          function safeNext(next) {
            if (
              !next ||
              next.includes("http://") ||
              next.includes("https://") ||
              next.startsWith("//")
            ) {
              return "chat.html";
            }
            // garde query/hash, enlève juste "/" au début
            return next.replace(/^\//, "");
          }

          function nextUrl() {
            return "./" + safeNext(getNext());
          }

          function cameFromOAuth() {
            return new URLSearchParams(location.search).get("oauth") === "1";
          }

          function setAlreadyConnectedUI(isConnected) {
            alreadyBox.style.display = isConnected ? "block" : "none";
            if (isConnected) goNextBtn.href = nextUrl();
          }

          // garder next dans les liens signup
          const nextEnc = encodeURIComponent(safeNext(getNext()));
          signup1.href = "./signup.html?next=" + nextEnc;
          signup2.href = "./signup.html?next=" + nextEnc;

          /* =========================
             ✅ BOOT: 1 seul flux
             - si oauth=1 ET session OK -> redirect
             - sinon -> affiche "déjà connecté" seulement (pas de redirect auto)
          ========================= */
          (async () => {
            try {
              const { data, error } = await supabase.auth.getSession();
              if (error) {
                showMsg("Erreur session: " + error.message, "err");
                return;
              }

              const hasSession = !!data?.session;

              if (cameFromOAuth()) {
                if (hasSession) {
                  window.location.href = nextUrl();
                  return;
                } else {
                  setLoading(false);
                  setAlreadyConnectedUI(false);
                  showMsg("Connexion Google incomplète. Réessaie.", "err");
                  return;
                }
              }

              if (hasSession) {
                setAlreadyConnectedUI(true);
                showMsg("Tu es déjà connectée.", "ok");
              } else {
                setAlreadyConnectedUI(false);
              }
            } catch (err) {
              showMsg("Erreur JS: " + (err?.message || String(err)), "err");
            }
          })();

          /* =========================
             Login email/password
          ========================= */
          loginForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            clearMsg();

            const email = document.getElementById("email").value.trim();
            const password = document.getElementById("password").value;

            if (!email || !email.includes("@")) return showMsg("Entre un email valide.", "err");
            if (!password || password.length < 6) return showMsg("Mot de passe invalide.", "err");

            setLoading(true);
            showMsg("Connexion…", "info");

            const { data, error } = await supabase.auth.signInWithPassword({
              email,
              password,
            });

            if (error) {
              setLoading(false);
              return showMsg(error.message, "err");
            }

            if (data?.session) {
              showMsg("Connecté. Redirection…", "ok");
              window.location.href = nextUrl();
              return;
            }

            setLoading(false);
            showMsg("Connexion faite, mais session introuvable. Réessaie.", "err");
          });

          /* =========================
             Google OAuth
          ========================= */
          googleBtn.addEventListener("click", async () => {
            clearMsg();
            setLoading(true);
            showMsg("Ouverture de Google…", "info");

            const next = safeNext(getNext());

            const { error } = await supabase.auth.signInWithOAuth({
              provider: "google",
              options: {
                redirectTo: origin() + "/login.html?oauth=1&next=" + encodeURIComponent(next),
              },
            });

            if (error) {
              setLoading(false);
              showMsg(error.message, "err");
            }
          });

          /* =========================
             Forgot password
          ========================= */
          forgotBtn.addEventListener("click", async () => {
            clearMsg();

            const email = document.getElementById("email").value.trim();
            if (!email || !email.includes("@")) {
              return showMsg("Entre ton email, puis clique “Mot de passe oublié ?”.", "err");
            }

            setLoading(true);
            showMsg("Envoi du lien de réinitialisation…", "info");

            const next = safeNext(getNext());

            const { error } = await supabase.auth.resetPasswordForEmail(email, {
              redirectTo: origin() + "/login.html?next=" + encodeURIComponent(next),
            });

            setLoading(false);

            if (error) return showMsg(error.message, "err");

            showMsg("Email envoyé. Vérifie ta boîte de réception (et indésirables).", "ok");
          });

          /* =========================
             Logout
          ========================= */
          logoutBtn.addEventListener("click", async () => {
            clearMsg();
            setLoading(true);
            showMsg("Déconnexion…", "info");

            const { error } = await supabase.auth.signOut();
            setLoading(false);

            if (error) return showMsg(error.message, "err");

            setAlreadyConnectedUI(false);
            showMsg("Déconnectée.", "ok");
          });

          /* =========================
             Auth state change = UI seulement
          ========================= */
          supabase.auth.onAuthStateChange((_event, session) => {
            if (session) {
              setAlreadyConnectedUI(true);
              setLoading(false);
            } else {
              setAlreadyConnectedUI(false);
            }
          });
        })();
      });
    </script>
  </body>
</html>
