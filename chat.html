<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Luna Astralis — Chat</title>
    <meta name="description" content="Chat Luna Astralis — Astro & psycho" />

    <link rel="stylesheet" href="./css/styles.css" />
    <link rel="stylesheet" href="./css/chat.css" />

    <style>
      .ai-book { margin-top: 10px; }
      .ai-book-link{
        display:inline-flex; align-items:center; gap:8px;
        font-size:12px; opacity:.65;
        text-decoration:underline; text-underline-offset:3px;
        color:rgba(255,255,255,.92);
      }
      .ai-book-link:hover{ opacity:.9; }

      .chat-logout{
        margin-left: 12px;
        font-size: 13px;
        opacity:.75;
        text-decoration: underline;
        text-underline-offset: 3px;
      }
      .chat-logout:hover{ opacity:1; }

      /* message visible si redirection login */
      .auth-redirect {
        padding: 12px 14px;
        border-radius: 14px;
        background: rgba(255,255,255,.07);
        border: 1px solid rgba(255,255,255,.12);
        color: rgba(255,255,255,.92);
        font-size: 14px;
        line-height: 1.35;
        margin: 12px;
      }

      /* mini bouton upgrade (si tu veux l'afficher plus tard) */
      .chat-upgrade{
        margin-left: 10px;
        font-size: 13px;
        opacity: .9;
        text-decoration: underline;
        text-underline-offset: 3px;
      }
      .chat-upgrade:hover{ opacity:1; }
    </style>
  </head>

  <body class="chat-body">
    <header class="chat-top" role="banner">
      <a class="chat-brand" href="./index.html" aria-label="Retour à l’accueil">
        <img class="chat-logo" src="./logo-luna-astralis-transparent.png" alt="Luna Astralis" />
        <div class="chat-brand-text">
          <div class="chat-brand-name">LUNA ASTRALIS</div>
          <div class="chat-brand-sub">Astro & psycho</div>
        </div>
      </a>

      <div style="display:flex; align-items:center; gap:14px;">
        <a class="chat-back" href="./index.html#signes">Changer de signe</a>

        <!-- (optionnel) upgrade à afficher seulement quand paywall -->
        <a class="chat-upgrade" href="#" id="upgradeLink" style="display:none;">Upgrade</a>

        <a class="chat-logout" href="#" id="logoutLink" style="display:none;">Déconnexion</a>
      </div>
    </header>

    <main class="chat-wrap" role="main">
      <aside class="chat-side" aria-label="Profil IA">
        <div class="ai-face-wrap">
          <img class="ai-face" src="./ia-luna-astralis.png" alt="Luna (IA)" />
        </div>

        <div>
          <div class="ai-name">Luna</div>
          <div class="ai-tag" id="aiTag">Signe : —</div>
          <div class="ai-desc" id="aiDesc">—</div>

          <div class="ai-book" id="aiBookWrap" style="display:none;">
            <a
              id="aiBookLink"
              class="ai-book-link"
              href="#"
              target="_blank"
              rel="noopener noreferrer"
              aria-label="Approfondir ce signe"
              title="Approfondir ce signe"
            >
              ✦ Approfondir ce signe
            </a>
          </div>

          <div style="margin-top:10px; font-size:12px; opacity:.7;" id="userEmail"></div>
        </div>

        <div class="ai-disclaimer">
          Outil d’exploration personnelle, non thérapeutique. Aucune thérapie, aucun diagnostic.
        </div>
      </aside>

      <section class="chat-panel" aria-label="Discussion">
        <!-- HERO MOBILE -->
        <div class="chat-hero" aria-hidden="true">
          <div class="chat-hero-inner">
            <img class="chat-hero-img" src="./ia-luna-astralis.png" alt="" />
            <div class="chat-hero-overlay"></div>

            <div class="chat-hero-card">
              <p class="hero-title" id="heroTitle">—</p>
              <p class="hero-desc" id="heroDesc">—</p>
            </div>
          </div>
        </div>

        <div class="chat-header">
          <div class="chat-title">
            Discussion <span class="chat-pill" id="signLabel">—</span>
          </div>
          <div class="ai-face-mini-wrap" aria-hidden="true">
            <img class="ai-face-mini" src="./ia-luna-astralis.png" alt="" />
          </div>
        </div>

        <div class="chat-messages" id="messages" role="log" aria-live="polite"></div>

        <form class="chat-inputbar" id="form" autocomplete="off">
          <input
            id="input"
            type="text"
            class="chat-input"
            placeholder="Écris ton message…"
            autocomplete="off"
          />
          <button class="chat-send" type="submit">Envoyer</button>
        </form>
      </section>
    </main>

    <!-- Supabase JS (UMD v2) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
      (function () {
        /* =========================
           SUPABASE (1 seul client)
        ========================= */
        const SUPABASE_URL = "https://auxhexhkrfyizqjvnpvn.supabase.co";
        const SUPABASE_KEY = "sb_publishable_jSrj1sEIrDuu73hJHhrnXw_vK7mlQeg";

        // ⚠️ si window.supabase n'existe pas, on évite un crash silencieux
        if (!window.supabase || !window.supabase.createClient) {
          document.body.innerHTML =
            '<div style="padding:18px;color:#fff;font-family:system-ui">Erreur: Supabase JS non chargé (cdn). Vérifie le script supabase-js.</div>';
          return;
        }

        const supabase =
          window.__LA_SUPABASE__ ||
          (window.__LA_SUPABASE__ = window.supabase.createClient(
            SUPABASE_URL,
            SUPABASE_KEY
          ));

        /* =========================
           ELEMENTS UI
        ========================= */
        const messagesEl = document.getElementById("messages");
        const form = document.getElementById("form");
        const input = document.getElementById("input");
        const userEmailEl = document.getElementById("userEmail");
        const logoutLink = document.getElementById("logoutLink");
        const upgradeLink = document.getElementById("upgradeLink");

        // garde un minimum visible si CSS/JS bug
        if (!messagesEl) return;

        function currentPathWithQuery() {
          const p = location.pathname.split("/").pop() || "chat.html";
          return p + location.search;
        }

        function showRedirectNotice(text) {
          messagesEl.innerHTML =
            '<div class="auth-redirect">' + (text || "Connexion requise. Redirection…") + "</div>";
        }

        function redirectToLogin() {
          const next = encodeURIComponent(currentPathWithQuery());
          showRedirectNotice("Connexion requise. Redirection vers “Mon compte”…");
          setTimeout(() => {
            window.location.href = "./login.html?next=" + next;
          }, 120);
        }

        function pricingUrl() {
          const next = encodeURIComponent(currentPathWithQuery());
          return "./pricing.html?next=" + next; // <-- change ici si ton pricing a un autre nom
        }

        /* =========================
           SESSION CACHE (évite spam getSession)
        ========================= */
        let SESSION = null;

        async function getSessionCached() {
          if (SESSION) return SESSION;
          try {
            const { data, error } = await supabase.auth.getSession();
            if (error || !data?.session) return null;
            SESSION = data.session;
            return SESSION;
          } catch (_) {
            return null;
          }
        }

        async function requireSessionOrRedirect() {
          const session = await getSessionCached();
          if (!session) {
            redirectToLogin();
            return null;
          }
          return session;
        }

        /* =========================
           SIGNE UI
        ========================= */
        const qs = (k) => new URLSearchParams(location.search).get(k) || "";
        const norm = (s) =>
          (s || "")
            .toLowerCase()
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .replace(/[^a-z]/g, "");

        const SIGNS = {
          belier: "Bélier ♈",
          taureau: "Taureau ♉",
          gemeaux: "Gémeaux ♊",
          cancer: "Cancer ♋",
          lion: "Lion ♌",
          vierge: "Vierge ♍",
          balance: "Balance ♎",
          scorpion: "Scorpion ♏",
          sagittaire: "Sagittaire ♐",
          capricorne: "Capricorne ♑",
          verseau: "Verseau ♒",
          poissons: "Poissons ♓",
        };

        const SIGN_DESC = {
          belier:
            "Énergie d’action et d’élan. On explore ton impulsion, ta colère (quand elle monte), et comment canaliser ton courage sans te brûler.",
          taureau:
            "Besoin de stabilité et de concret. On explore l’attachement, le plaisir, la sécurité intérieure, et comment lâcher sans perdre ton ancrage.",
          gemeaux:
            "Mental rapide et curiosité. On explore tes pensées en boucle, ta dualité, et comment clarifier ce que tu ressens derrière ce que tu analyses.",
          cancer:
            "Hyper-sensibilité et protection. On explore tes besoins affectifs, tes limites, et comment te sentir en sécurité sans tout porter seul·e.",
          lion:
            "Rayonnement et fierté du cœur. On explore l’estime de soi, la reconnaissance, et comment briller sans te suradapter au regard des autres.",
          vierge:
            "Lucidité et exigence. On explore le contrôle, la charge mentale, et comment trouver du calme quand tu veux que tout soit “bien fait”.",
          balance:
            "Équilibre et relation. On explore la peur du conflit, le besoin d’harmonie, et comment dire “non” sans culpabilité.",
          scorpion:
            "Intensité et transformation. On explore la confiance, la jalousie/la peur de perdre, et comment traverser une émotion sans te fermer.",
          sagittaire:
            "Sens et liberté. On explore l’ennui, l’envie d’ailleurs, et comment rester aligné·e quand tu te sens coincé·e ou limité·e.",
          capricorne:
            "Structure et responsabilité. On explore la pression, la performance, et comment te reposer sans te sentir “inutile”.",
          verseau:
            "Indépendance et vision. On explore la distance émotionnelle, ton besoin d’espace, et comment te connecter sans te sentir envahi·e.",
          poissons:
            "Intuition et empathie. On explore l’hypersensibilité, la fatigue émotionnelle, et comment te protéger sans t’éteindre.",
        };

        const SIGN_BOOKS = {
          belier: "https://a.co/d/ipv7KsG",
          taureau: "https://a.co/d/cNzESwI",
          gemeaux: "https://a.co/d/5rzhkCv",
          cancer: "https://a.co/d/9T3gj30",
          lion: "https://a.co/d/eQ0Fa2u",
          vierge: "https://a.co/d/7mMxP9f",
          balance: "https://a.co/d/i93cts5",
          scorpion: "https://a.co/d/0HQBCE8",
          sagittaire: "https://a.co/d/iOLDHqS",
          capricorne: "https://a.co/d/4JuWLu1",
          verseau: "https://a.co/d/de3Ukra",
          poissons: "https://a.co/d/hIM81yC",
        };

        const rawKey = qs("signe") || qs("sign") || "belier";
        const signKey = norm(rawKey) || "belier";

        const signName = SIGNS[signKey] || "—";
        const signDesc =
          SIGN_DESC[signKey] ||
          "Exploration douce : émotions, relations, stress, schémas, besoins, limites.";

        const signLabelEl = document.getElementById("signLabel");
        const aiTagEl = document.getElementById("aiTag");
        const aiDescEl = document.getElementById("aiDesc");
        const heroTitleEl = document.getElementById("heroTitle");
        const heroDescEl = document.getElementById("heroDesc");

        if (signLabelEl) signLabelEl.textContent = signName;
        if (aiTagEl) aiTagEl.textContent = "Signe : " + signName;
        if (aiDescEl) aiDescEl.textContent = signDesc;
        if (heroTitleEl) heroTitleEl.textContent = "Ton signe : " + signName;
        if (heroDescEl) heroDescEl.textContent = signDesc;

        const bookUrl = SIGN_BOOKS[signKey];
        const wrap = document.getElementById("aiBookWrap");
        const link = document.getElementById("aiBookLink");
        if (wrap && link && bookUrl) {
          wrap.style.display = "block";
          link.href = bookUrl;
        }

        /* =========================
           CHAT UI
        ========================= */
        function addMessage(role, text) {
          const row = document.createElement("div");
          row.className = "msg-row " + (role === "ai" ? "msg-ai" : "msg-user");

          if (role === "ai") {
            const avatar = document.createElement("img");
            avatar.className = "msg-avatar";
            avatar.src = "./ia-luna-astralis.png";
            avatar.alt = "Luna (IA)";
            row.appendChild(avatar);
          } else {
            const spacer = document.createElement("div");
            spacer.className = "msg-avatar-spacer";
            row.appendChild(spacer);
          }

          const bubble = document.createElement("div");
          bubble.className = "msg-bubble";
          bubble.textContent = text;

          row.appendChild(bubble);
          messagesEl.appendChild(row);
          messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        function aiReply() {
          return (
            "Parfait. Donne-moi un exemple précis :\n" +
            "1) Qu’est-ce qui s’est passé ?\n" +
            "2) Qu’as-tu ressenti dans ton corps ?\n" +
            "3) Quelle pensée automatique est arrivée ?"
          );
        }

        /* =========================
           INIT + AUTH GUARD
        ========================= */
        (async () => {
          const session = await requireSessionOrRedirect();
          if (!session) return;

          // affichage email + logout
          if (userEmailEl) userEmailEl.textContent = session.user?.email ? session.user.email : "";
          if (logoutLink) logoutLink.style.display = "inline";

          addMessage(
            "ai",
            "Salut ✨ Dis-moi ce que tu veux comprendre aujourd’hui (émotions, relations, stress, schémas…)."
          );
        })();

        /* =========================
           SEND
        ========================= */
        if (form) {
          form.addEventListener("submit", async (e) => {
            e.preventDefault();

            const session = await requireSessionOrRedirect();
            if (!session) return;

            const text = (input && input.value ? input.value : "").trim();
            if (!text) return;

            addMessage("user", text);
            if (input) {
              input.value = "";
              input.focus();
            }

            setTimeout(() => addMessage("ai", aiReply(text)), 320);
          });
        }

        /* =========================
           LOGOUT
        ========================= */
        if (logoutLink) {
          logoutLink.addEventListener("click", async (e) => {
            e.preventDefault();
            await supabase.auth.signOut();
            redirectToLogin();
          });
        }

        /* =========================
           UPGRADE (optionnel)
        ========================= */
        if (upgradeLink) {
          upgradeLink.href = pricingUrl();
          upgradeLink.addEventListener("click", (e) => {
            // laisse le lien fonctionner normalement
          });
        }

        /* =========================
           Si session change (déco ailleurs) -> login
        ========================= */
        supabase.auth.onAuthStateChange((event, session) => {
          SESSION = session || null;
          if (!SESSION) {
            redirectToLogin();
          }
        });
      })();
    </script>
  </body>
</html>
