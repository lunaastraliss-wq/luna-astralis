<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Luna Astralis — Chat</title>
    <meta name="description" content="Chat Luna Astralis — Astro & psycho" />

    <link rel="stylesheet" href="./css/styles.css" />
    <link rel="stylesheet" href="./css/chat.css" />

    <style>
      .ai-book { margin-top: 10px; }
      .ai-book-link{
        display:inline-flex; align-items:center; gap:8px;
        font-size:12px; opacity:.65;
        text-decoration:underline; text-underline-offset:3px;
        color:rgba(255,255,255,.92);
      }
      .ai-book-link:hover{ opacity:.9; }

      .chat-logout{
        margin-left: 12px;
        font-size: 13px;
        opacity:.75;
        text-decoration: underline;
        text-underline-offset: 3px;
      }
      .chat-logout:hover{ opacity:1; }

      .auth-redirect {
        padding: 12px 14px;
        border-radius: 14px;
        background: rgba(255,255,255,.07);
        border: 1px solid rgba(255,255,255,.12);
        color: rgba(255,255,255,.92);
        font-size: 14px;
        line-height: 1.35;
        margin: 12px;
      }

      .chat-upgrade{
        margin-left: 10px;
        font-size: 13px;
        opacity: .9;
        text-decoration: underline;
        text-underline-offset: 3px;
      }
      .chat-upgrade:hover{ opacity:1; }

      .chat-paywall{
        margin: 12px;
        padding: 12px 14px;
        border-radius: 14px;
        background: rgba(255,255,255,.07);
        border: 1px solid rgba(255,255,255,.12);
        color: rgba(255,255,255,.92);
        font-size: 14px;
        line-height: 1.35;
      }
      .chat-paywall strong{ font-weight: 700; }
      .chat-input[disabled]{ opacity:.6; }
      .chat-send[disabled]{ opacity:.6; cursor:not-allowed; }
    </style>
  </head>

  <body class="chat-body">
    <header class="chat-top" role="banner">
      <a class="chat-brand" href="./index.html" aria-label="Retour à l’accueil">
        <img class="chat-logo" src="./logo-luna-astralis-transparent.png" alt="Luna Astralis" />
        <div class="chat-brand-text">
          <div class="chat-brand-name">LUNA ASTRALIS</div>
          <div class="chat-brand-sub">Astro & psycho</div>
        </div>
      </a>

      <div style="display:flex; align-items:center; gap:14px;">
        <a class="chat-back" href="./index.html#signes">Changer de signe</a>
        <a class="chat-upgrade" href="#" id="upgradeLink" style="display:none;">Upgrade</a>
        <a class="chat-logout" href="#" id="logoutLink" style="display:none;">Déconnexion</a>
      </div>
    </header>

    <main class="chat-wrap" role="main">
      <aside class="chat-side" aria-label="Profil IA">
        <div class="ai-face-wrap">
          <img class="ai-face" src="./ia-luna-astralis.png" alt="Luna (IA)" />
        </div>

        <div>
          <div class="ai-name">Luna</div>
          <div class="ai-tag" id="aiTag">Signe : —</div>
          <div class="ai-desc" id="aiDesc">—</div>

          <div class="ai-book" id="aiBookWrap" style="display:none;">
            <a
              id="aiBookLink"
              class="ai-book-link"
              href="#"
              target="_blank"
              rel="noopener noreferrer"
              aria-label="Approfondir ce signe"
              title="Approfondir ce signe"
            >
              ✦ Approfondir ce signe
            </a>
          </div>

          <div style="margin-top:10px; font-size:12px; opacity:.7;" id="userEmail"></div>
        </div>

        <div class="ai-disclaimer">
          Outil d’exploration personnelle, non thérapeutique. Aucune thérapie, aucun diagnostic.
        </div>
      </aside>

      <section class="chat-panel" aria-label="Discussion">
        <!-- HERO MOBILE -->
        <div class="chat-hero" aria-hidden="true">
          <div class="chat-hero-inner">
            <img class="chat-hero-img" src="./ia-luna-astralis.png" alt="" />
            <div class="chat-hero-overlay"></div>

            <div class="chat-hero-card">
              <p class="hero-title" id="heroTitle">—</p>
              <p class="hero-desc" id="heroDesc">—</p>
            </div>
          </div>
        </div>

        <div class="chat-header">
          <div class="chat-title">
            Discussion <span class="chat-pill" id="signLabel">—</span>
          </div>
          <div class="ai-face-mini-wrap" aria-hidden="true">
            <img class="ai-face-mini" src="./ia-luna-astralis.png" alt="" />
          </div>
        </div>

        <div class="chat-messages" id="messages" role="log" aria-live="polite"></div>

        <form class="chat-inputbar" id="form" autocomplete="off">
          <input
            id="input"
            type="text"
            class="chat-input"
            placeholder="Écris ton message…"
            autocomplete="off"
          />
          <button class="chat-send" id="sendBtn" type="submit">Envoyer</button>
        </form>
      </section>
    </main>

    <!-- Supabase JS (UMD v2) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
      (function () {
        /* =========================
           CONFIG
        ========================= */
        const SUPABASE_URL = "https://auxhexhkrfyizqjvnpvn.supabase.co";
        const SUPABASE_KEY = "sb_publishable_jSrj1sEIrDuu73hJHhrnXw_vK7mlQeg";

        // ✅ LIMITE (tu as dit: 15 max, pareil pour tous)
        const MAX_USER_MESSAGES_PER_CHAT = 15;

        /* =========================
           Supabase client
        ========================= */
        if (!window.supabase || !window.supabase.createClient) {
          document.body.innerHTML =
            '<div style="padding:18px;color:#fff;font-family:system-ui">Erreur: Supabase JS non chargé (cdn). Vérifie le script supabase-js.</div>';
          return;
        }

        const supabase =
          window.__LA_SUPABASE__ ||
          (window.__LA_SUPABASE__ = window.supabase.createClient(
            SUPABASE_URL,
            SUPABASE_KEY
          ));

        /* =========================
           Elements
        ========================= */
        const messagesEl = document.getElementById("messages");
        const form = document.getElementById("form");
        const input = document.getElementById("input");
        const sendBtn = document.getElementById("sendBtn");
        const userEmailEl = document.getElementById("userEmail");
        const logoutLink = document.getElementById("logoutLink");
        const upgradeLink = document.getElementById("upgradeLink");

        if (!messagesEl) return;

        function safeText(s) { return (s || "").toString(); }

        function currentPathWithQuery() {
          const p = location.pathname.split("/").pop() || "chat.html";
          return p + location.search; // ex: chat.html?signe=belier
        }

        function showNotice(html) {
          messagesEl.innerHTML = html;
        }

        function showRedirectNotice(text) {
          showNotice('<div class="auth-redirect">' + safeText(text || "Connexion requise. Redirection…") + "</div>");
        }

        function redirectToLogin() {
          const next = encodeURIComponent(currentPathWithQuery());
          showRedirectNotice("Connexion requise. Redirection vers “Mon compte”…");
          setTimeout(() => {
            window.location.href = "./login.html?next=" + next;
          }, 120);
        }

        function pricingUrl() {
          const next = encodeURIComponent(currentPathWithQuery());
          return "./pricing.html?next=" + next;
        }

        /* =========================
           Session cache
        ========================= */
        let SESSION = null;

        async function getSessionCached() {
          if (SESSION) return SESSION;
          try {
            const { data, error } = await supabase.auth.getSession();
            if (error || !data?.session) return null;
            SESSION = data.session;
            return SESSION;
          } catch (_) {
            return null;
          }
        }

        async function requireSessionOrRedirect() {
          const session = await getSessionCached();
          if (!session) {
            redirectToLogin();
            return null;
          }
          return session;
        }

        /* =========================
           Sign UI
        ========================= */
        const qs = (k) => new URLSearchParams(location.search).get(k) || "";
        const norm = (s) =>
          (s || "")
            .toLowerCase()
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .replace(/[^a-z]/g, "");

        const SIGNS = {
          belier: "Bélier ♈",
          taureau: "Taureau ♉",
          gemeaux: "Gémeaux ♊",
          cancer: "Cancer ♋",
          lion: "Lion ♌",
          vierge: "Vierge ♍",
          balance: "Balance ♎",
          scorpion: "Scorpion ♏",
          sagittaire: "Sagittaire ♐",
          capricorne: "Capricorne ♑",
          verseau: "Verseau ♒",
          poissons: "Poissons ♓",
        };

        const SIGN_DESC = {
          belier:
            "Énergie d’action et d’élan. On explore ton impulsion, ta colère (quand elle monte), et comment canaliser ton courage sans te brûler.",
          taureau:
            "Besoin de stabilité et de concret. On explore l’attachement, le plaisir, la sécurité intérieure, et comment lâcher sans perdre ton ancrage.",
          gemeaux:
            "Mental rapide et curiosité. On explore tes pensées en boucle, ta dualité, et comment clarifier ce que tu ressens derrière ce que tu analyses.",
          cancer:
            "Hyper-sensibilité et protection. On explore tes besoins affectifs, tes limites, et comment te sentir en sécurité sans tout porter seul·e.",
          lion:
            "Rayonnement et fierté du cœur. On explore l’estime de soi, la reconnaissance, et comment briller sans te suradapter au regard des autres.",
          vierge:
            "Lucidité et exigence. On explore le contrôle, la charge mentale, et comment trouver du calme quand tu veux que tout soit “bien fait”.",
          balance:
            "Équilibre et relation. On explore la peur du conflit, le besoin d’harmonie, et comment dire “non” sans culpabilité.",
          scorpion:
            "Intensité et transformation. On explore la confiance, la jalousie/la peur de perdre, et comment traverser une émotion sans te fermer.",
          sagittaire:
            "Sens et liberté. On explore l’ennui, l’envie d’ailleurs, et comment rester aligné·e quand tu te sens coincé·e ou limité·e.",
          capricorne:
            "Structure et responsabilité. On explore la pression, la performance, et comment te reposer sans te sentir “inutile”.",
          verseau:
            "Indépendance et vision. On explore la distance émotionnelle, ton besoin d’espace, et comment te connecter sans te sentir envahi·e.",
          poissons:
            "Intuition et empathie. On explore l’hypersensibilité, la fatigue émotionnelle, et comment te protéger sans t’éteindre.",
        };

        const SIGN_BOOKS = {
          belier: "https://a.co/d/ipv7KsG",
          taureau: "https://a.co/d/cNzESwI",
          gemeaux: "https://a.co/d/5rzhkCv",
          cancer: "https://a.co/d/9T3gj30",
          lion: "https://a.co/d/eQ0Fa2u",
          vierge: "https://a.co/d/7mMxP9f",
          balance: "https://a.co/d/i93cts5",
          scorpion: "https://a.co/d/0HQBCE8",
          sagittaire: "https://a.co/d/iOLDHqS",
          capricorne: "https://a.co/d/4JuWLu1",
          verseau: "https://a.co/d/de3Ukra",
          poissons: "https://a.co/d/hIM81yC",
        };

        const rawKey = qs("signe") || qs("sign") || "belier";
        const signKey = norm(rawKey) || "belier";

        const signName = SIGNS[signKey] || "—";
        const signDesc =
          SIGN_DESC[signKey] ||
          "Exploration douce : émotions, relations, stress, schémas, besoins, limites.";

        const signLabelEl = document.getElementById("signLabel");
        const aiTagEl = document.getElementById("aiTag");
        const aiDescEl = document.getElementById("aiDesc");
        const heroTitleEl = document.getElementById("heroTitle");
        const heroDescEl = document.getElementById("heroDesc");

        if (signLabelEl) signLabelEl.textContent = signName;
        if (aiTagEl) aiTagEl.textContent = "Signe : " + signName;
        if (aiDescEl) aiDescEl.textContent = signDesc;
        if (heroTitleEl) heroTitleEl.textContent = "Ton signe : " + signName;
        if (heroDescEl) heroDescEl.textContent = signDesc;

        const bookUrl = SIGN_BOOKS[signKey];
        const wrap = document.getElementById("aiBookWrap");
        const link = document.getElementById("aiBookLink");
        if (wrap && link && bookUrl) {
          wrap.style.display = "block";
          link.href = bookUrl;
        }

        /* =========================
           Chat UI
        ========================= */
        function addMessage(role, text) {
          const row = document.createElement("div");
          row.className = "msg-row " + (role === "ai" ? "msg-ai" : "msg-user");

          if (role === "ai") {
            const avatar = document.createElement("img");
            avatar.className = "msg-avatar";
            avatar.src = "./ia-luna-astralis.png";
            avatar.alt = "Luna (IA)";
            row.appendChild(avatar);
          } else {
            const spacer = document.createElement("div");
            spacer.className = "msg-avatar-spacer";
            row.appendChild(spacer);
          }

          const bubble = document.createElement("div");
          bubble.className = "msg-bubble";
          bubble.textContent = safeText(text);

          row.appendChild(bubble);
          messagesEl.appendChild(row);
          messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        function aiReplyFallback() {
          return (
            "Parfait. Donne-moi un exemple précis :\n" +
            "1) Qu’est-ce qui s’est passé ?\n" +
            "2) Qu’as-tu ressenti dans ton corps ?\n" +
            "3) Quelle pensée automatique est arrivée ?"
          );
        }

        function setInputEnabled(enabled) {
          if (input) input.disabled = !enabled;
          if (sendBtn) sendBtn.disabled = !enabled;
        }

        function showPaywall() {
          // show upgrade link + disable input
          if (upgradeLink) {
            upgradeLink.href = pricingUrl();
            upgradeLink.style.display = "inline";
          }
          setInputEnabled(false);
          addMessage(
            "ai",
            "Tu as atteint la limite de ce chat. Clique sur “Upgrade” pour voir les options."
          );
        }

        /* =========================
           Conversation / Messages (DB)
        ========================= */
        function getConversationIdFromUrl() {
          const p = new URLSearchParams(location.search);
          return p.get("c") || "";
        }

        function setConversationIdInUrl(conversationId) {
          const url = new URL(location.href);
          url.searchParams.set("c", conversationId);
          history.replaceState({}, "", url.toString());
        }

        async function insertConversation(session) {
          // On tente AVEC sign_key, puis on retente SANS si la colonne n'existe pas
          const payloadA = { user_id: session.user.id, sign_key: signKey };
          const payloadB = { user_id: session.user.id };

          let res = await supabase
            .from("conversations")
            .insert(payloadA)
            .select("id")
            .single();

          if (res.error) {
            const msg = (res.error.message || "").toLowerCase();
            const maybeColumnMissing =
              msg.includes("column") && (msg.includes("sign_key") || msg.includes("signkey"));
            if (maybeColumnMissing) {
              res = await supabase
                .from("conversations")
                .insert(payloadB)
                .select("id")
                .single();
            }
          }

          return res;
        }

        async function ensureConversation(session) {
          const existing = getConversationIdFromUrl();
          if (existing) return existing;

          const { data, error } = await insertConversation(session);

          if (error || !data?.id) {
            console.error("create conversation error:", error);
            addMessage("ai", "Erreur: impossible de créer la conversation (Supabase).");
            return null;
          }

          setConversationIdInUrl(data.id);
          return data.id;
        }

        async function loadMessages(conversationId) {
          const { data, error } = await supabase
            .from("chat_messages")
            .select("role, content, created_at")
            .eq("conversation_id", conversationId)
            .order("created_at", { ascending: true });

          if (error) {
            console.error("load messages error:", error);
            addMessage("ai", "Erreur: impossible de charger l’historique (Supabase).");
            return [];
          }

          messagesEl.innerHTML = "";
          for (const m of data || []) {
            addMessage(m.role === "ai" ? "ai" : "user", m.content || "");
          }
          return data || [];
        }

        async function insertChatMessage({ conversationId, session, role, content }) {
          // On tente AVEC sign_key, puis SANS si colonne absente
          const rowA = {
            conversation_id: conversationId,
            user_id: session.user.id,
            role,
            content,
            sign_key: signKey,
          };
          const rowB = {
            conversation_id: conversationId,
            user_id: session.user.id,
            role,
            content,
          };

          let res = await supabase.from("chat_messages").insert(rowA);
          if (res.error) {
            const msg = (res.error.message || "").toLowerCase();
            const maybeColumnMissing =
              msg.includes("column") && (msg.includes("sign_key") || msg.includes("signkey"));
            if (maybeColumnMissing) {
              res = await supabase.from("chat_messages").insert(rowB);
            }
          }
          return res;
        }

        async function countUserMessages(conversationId) {
          // count user messages only (role='user')
          const { count, error } = await supabase
            .from("chat_messages")
            .select("id", { count: "exact", head: true })
            .eq("conversation_id", conversationId)
            .eq("role", "user");

          if (error) {
            console.error("count user messages error:", error);
            return 0;
          }
          return count || 0;
        }

        async function enforceLimit(conversationId) {
          const used = await countUserMessages(conversationId);
          if (used >= MAX_USER_MESSAGES_PER_CHAT) {
            showPaywall();
            return false;
          }
          // si proche de la limite, tu peux montrer upgrade (optionnel)
          if (upgradeLink && used >= Math.max(1, MAX_USER_MESSAGES_PER_CHAT - 3)) {
            upgradeLink.href = pricingUrl();
            upgradeLink.style.display = "inline";
          }
          return true;
        }

        /* =========================
           INIT
        ========================= */
        (async () => {
          // affiche quelque chose tout de suite si jamais auth prend 1-2 sec
          showNotice('<div class="auth-redirect">Chargement…</div>');

          const session = await requireSessionOrRedirect();
          if (!session) return;

          if (userEmailEl) userEmailEl.textContent = session.user?.email ? session.user.email : "";
          if (logoutLink) logoutLink.style.display = "inline";

          const conversationId = await ensureConversation(session);
          if (!conversationId) return;

          const history = await loadMessages(conversationId);

          // Limite (15)
          const ok = await enforceLimit(conversationId);
          if (!ok) return;

          // Message d’accueil seulement si vide
          if (!history.length) {
            const welcome =
              "Salut ✨ Dis-moi ce que tu veux comprendre aujourd’hui (émotions, relations, stress, schémas…).";
            addMessage("ai", welcome);
            await insertChatMessage({ conversationId, session, role: "ai", content: welcome });
          }

          // Upgrade link (au cas où)
          if (upgradeLink) {
            upgradeLink.href = pricingUrl();
            upgradeLink.style.display = "none";
          }
        })();

        /* =========================
           SEND
        ========================= */
        if (form) {
          form.addEventListener("submit", async (e) => {
            e.preventDefault();

            const session = await requireSessionOrRedirect();
            if (!session) return;

            const conversationId = getConversationIdFromUrl();
            if (!conversationId) {
              addMessage("ai", "Erreur: conversation introuvable.");
              return;
            }

            // check limit BEFORE sending
            const ok = await enforceLimit(conversationId);
            if (!ok) return;

            const text = (input && input.value ? input.value : "").trim();
            if (!text) return;

            // UI
            addMessage("user", text);
            if (input) {
              input.value = "";
              input.focus();
            }

            // DB save user message
            const insUser = await insertChatMessage({ conversationId, session, role: "user", content: text });
            if (insUser.error) {
              console.error("insert user msg error:", insUser.error);
              addMessage("ai", "Erreur: impossible d’enregistrer ton message.");
              return;
            }

            // check limit AFTER saving user message
            const okAfter = await enforceLimit(conversationId);
            if (!okAfter) return;

            // AI reply (fallback local for now)
            setTimeout(async () => {
              const reply = aiReplyFallback();
              addMessage("ai", reply);

              const insAi = await insertChatMessage({ conversationId, session, role: "ai", content: reply });
              if (insAi.error) {
                console.error("insert ai msg error:", insAi.error);
                // pas bloquant
              }
            }, 320);
          });
        }

        /* =========================
           LOGOUT
        ========================= */
        if (logoutLink) {
          logoutLink.addEventListener("click", async (e) => {
            e.preventDefault();
            await supabase.auth.signOut();
            redirectToLogin();
          });
        }

        /* =========================
           UPGRADE link
        ========================= */
        if (upgradeLink) {
          upgradeLink.href = pricingUrl();
          upgradeLink.addEventListener("click", () => {
            // lien normal
          });
        }

        /* =========================
           Session change -> login
        ========================= */
        supabase.auth.onAuthStateChange((event, session) => {
          SESSION = session || null;
          if (!SESSION) {
            redirectToLogin();
          }
        });
      })();
    </script>
  </body>
</html>
