<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Luna Astralis — Chat</title>
    <meta name="description" content="Chat Luna Astralis — Astro & psycho" />

    <link rel="stylesheet" href="./css/styles.css" />
    <link rel="stylesheet" href="./css/chat.css" />

    <style>
      .ai-book { margin-top: 10px; }
      .ai-book-link{
        display:inline-flex; align-items:center; gap:8px;
        font-size:12px; opacity:.65;
        text-decoration:underline; text-underline-offset:3px;
        color:rgba(255,255,255,.92);
      }
      .ai-book-link:hover{ opacity:.9; }

      .chat-logout{
        margin-left: 12px;
        font-size: 13px;
        opacity:.75;
        text-decoration: underline;
        text-underline-offset: 3px;
      }
      .chat-logout:hover{ opacity:1; }

      .chat-upgrade{
        margin-left: 10px;
        font-size: 13px;
        opacity: .9;
        text-decoration: underline;
        text-underline-offset: 3px;
      }
      .chat-upgrade:hover{ opacity:1; }

      /* ===== Paywall overlay (Replika-like) ===== */
      .paywall {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 18px;
        background: rgba(0,0,0,.55);
        backdrop-filter: blur(6px);
        z-index: 9999;
      }
      .paywall-card{
        width: min(520px, 100%);
        border-radius: 22px;
        padding: 18px 18px 16px;
        background: rgba(255,255,255,.08);
        border: 1px solid rgba(255,255,255,.14);
        box-shadow: 0 25px 70px rgba(0,0,0,.55);
        color: rgba(255,255,255,.92);
      }
      .paywall-title{
        font-size: 18px;
        font-weight: 700;
        margin: 0 0 6px;
        letter-spacing: .2px;
      }
      .paywall-desc{
        margin: 0 0 14px;
        opacity: .85;
        line-height: 1.35;
        font-size: 14px;
      }
      .paywall-actions{
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      .btn{
        appearance: none;
        border: 1px solid rgba(255,255,255,.18);
        background: rgba(255,255,255,.10);
        color: rgba(255,255,255,.92);
        padding: 10px 12px;
        border-radius: 14px;
        font-size: 14px;
        cursor: pointer;
        text-decoration: none;
        display:inline-flex;
        align-items:center;
        justify-content:center;
        gap:8px;
      }
      .btn:hover{ background: rgba(255,255,255,.14); }
      .btn-primary{
        background: rgba(215,199,255,.18);
        border-color: rgba(215,199,255,.28);
      }
      .btn-primary:hover{ background: rgba(215,199,255,.24); }
      .paywall-foot{
        margin-top: 12px;
        font-size: 12px;
        opacity: .75;
        line-height: 1.35;
      }

      .mode-pill{
        display:inline-flex;
        align-items:center;
        gap:8px;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid rgba(255,255,255,.14);
        background: rgba(255,255,255,.06);
        font-size: 12px;
        opacity: .85;
      }
      .mode-dot{
        width:8px;height:8px;border-radius:999px;
        background: rgba(255,255,255,.75);
      }
      .mode-dot.green{ background: rgba(120,255,190,.85); }
    </style>
  </head>

  <body class="chat-body">
    <header class="chat-top" role="banner">
      <a class="chat-brand" href="./index.html" aria-label="Retour à l’accueil">
        <img class="chat-logo" src="./logo-luna-astralis-transparent.png" alt="Luna Astralis" />
        <div class="chat-brand-text">
          <div class="chat-brand-name">LUNA ASTRALIS</div>
          <div class="chat-brand-sub">Astro & psycho</div>
        </div>
      </a>

      <div style="display:flex; align-items:center; gap:14px;">
        <a class="chat-back" href="./index.html#signes">Changer de signe</a>

        <span class="mode-pill" id="modePill" title="Mode actuel">
          <span class="mode-dot" id="modeDot"></span>
          <span id="modeText">Invité</span>
        </span>

        <a class="chat-upgrade" href="#" id="upgradeLink" style="display:none;">Upgrade</a>
        <a class="chat-logout" href="#" id="logoutLink" style="display:none;">Déconnexion</a>
      </div>
    </header>

    <main class="chat-wrap" role="main">
      <aside class="chat-side" aria-label="Profil IA">
        <div class="ai-face-wrap">
          <img class="ai-face" src="./ia-luna-astralis.png" alt="Luna (IA)" />
        </div>

        <div>
          <div class="ai-name">Luna</div>
          <div class="ai-tag" id="aiTag">Signe : —</div>
          <div class="ai-desc" id="aiDesc">—</div>

          <div class="ai-book" id="aiBookWrap" style="display:none;">
            <a
              id="aiBookLink"
              class="ai-book-link"
              href="#"
              target="_blank"
              rel="noopener noreferrer"
              aria-label="Approfondir ce signe"
              title="Approfondir ce signe"
            >
              ✦ Approfondir ce signe
            </a>
          </div>

          <div style="margin-top:10px; font-size:12px; opacity:.7;" id="userEmail"></div>
          <div style="margin-top:6px; font-size:12px; opacity:.7;" id="freeCounter"></div>
        </div>

        <div class="ai-disclaimer">
          Outil d’exploration personnelle, non thérapeutique. Aucune thérapie, aucun diagnostic.
        </div>
      </aside>

      <section class="chat-panel" aria-label="Discussion">
        <!-- HERO MOBILE -->
        <div class="chat-hero" aria-hidden="true">
          <div class="chat-hero-inner">
            <img class="chat-hero-img" src="./ia-luna-astralis.png" alt="" />
            <div class="chat-hero-overlay"></div>

            <div class="chat-hero-card">
              <p class="hero-title" id="heroTitle">—</p>
              <p class="hero-desc" id="heroDesc">—</p>
            </div>
          </div>
        </div>

        <div class="chat-header">
          <div class="chat-title">
            Discussion <span class="chat-pill" id="signLabel">—</span>
          </div>
          <div class="ai-face-mini-wrap" aria-hidden="true">
            <img class="ai-face-mini" src="./ia-luna-astralis.png" alt="" />
          </div>
        </div>

        <div class="chat-messages" id="messages" role="log" aria-live="polite"></div>

        <form class="chat-inputbar" id="form" autocomplete="off">
          <input
            id="input"
            type="text"
            class="chat-input"
            placeholder="Écris ton message…"
            autocomplete="off"
          />
          <button class="chat-send" type="submit">Envoyer</button>
        </form>
      </section>
    </main>

    <!-- Paywall overlay -->
    <div class="paywall" id="paywall">
      <div class="paywall-card" role="dialog" aria-modal="true" aria-label="Continuer la discussion">
        <h3 class="paywall-title">Continuer la discussion</h3>
        <p class="paywall-desc" id="paywallDesc">
          Tu as atteint la limite gratuite. Crée un compte (gratuit) pour continuer et retrouver tes échanges.
        </p>
        <div class="paywall-actions">
          <a class="btn btn-primary" id="paywallLogin" href="./login.html">Créer un compte / Se connecter</a>
          <a class="btn" id="paywallPricing" href="./pricing.html">Voir les offres</a>
          <button class="btn" id="paywallClose" type="button">Fermer</button>
        </div>
        <div class="paywall-foot">
          Astuce : tu peux démarrer en invité. Le compte sert à sauvegarder ton historique et débloquer plus de messages.
        </div>
      </div>
    </div>

    <!-- Supabase JS (UMD v2) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
      (function () {
        /* =========================
           CONFIG
        ========================= */
        const SUPABASE_URL = "https://auxhexhkrfyizqjvnpvn.supabase.co";
        const SUPABASE_KEY = "sb_publishable_jSrj1sEIrDuu73hJHhrnXw_vK7mlQeg";

        const FREE_LIMIT = 15;
        const STORAGE_PREFIX = "la_chat_";

        /* =========================
           SAFE SUPABASE LOAD
        ========================= */
        if (!window.supabase || !window.supabase.createClient) {
          document.body.innerHTML =
            '<div style="padding:18px;color:#fff;font-family:system-ui">Erreur: Supabase JS non chargé (cdn). Vérifie le script supabase-js.</div>';
          return;
        }

        const supabase =
          window.__LA_SUPABASE__ ||
          (window.__LA_SUPABASE__ = window.supabase.createClient(
            SUPABASE_URL,
            SUPABASE_KEY
          ));

        /* =========================
           ELEMENTS
        ========================= */
        const messagesEl = document.getElementById("messages");
        const form = document.getElementById("form");
        const input = document.getElementById("input");

        const userEmailEl = document.getElementById("userEmail");
        const freeCounterEl = document.getElementById("freeCounter");

        const logoutLink = document.getElementById("logoutLink");
        const upgradeLink = document.getElementById("upgradeLink");

        const modeDot = document.getElementById("modeDot");
        const modeText = document.getElementById("modeText");

        const paywallEl = document.getElementById("paywall");
        const paywallLogin = document.getElementById("paywallLogin");
        const paywallPricing = document.getElementById("paywallPricing");
        const paywallClose = document.getElementById("paywallClose");

        if (!messagesEl) return;

        /* =========================
           URL helpers
        ========================= */
        function currentPathWithQuery() {
          const p = location.pathname.split("/").pop() || "chat.html";
          return p + location.search;
        }
        function loginUrl() {
          const next = encodeURIComponent(currentPathWithQuery());
          return "./login.html?next=" + next;
        }
        function pricingUrl() {
          const next = encodeURIComponent(currentPathWithQuery());
          return "./pricing.html?next=" + next;
        }

        /* =========================
           SIGN
        ========================= */
        const qs = (k) => new URLSearchParams(location.search).get(k) || "";
        const norm = (s) =>
          (s || "")
            .toLowerCase()
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .replace(/[^a-z]/g, "");

        const SIGNS = {
          belier: "Bélier ♈",
          taureau: "Taureau ♉",
          gemeaux: "Gémeaux ♊",
          cancer: "Cancer ♋",
          lion: "Lion ♌",
          vierge: "Vierge ♍",
          balance: "Balance ♎",
          scorpion: "Scorpion ♏",
          sagittaire: "Sagittaire ♐",
          capricorne: "Capricorne ♑",
          verseau: "Verseau ♒",
          poissons: "Poissons ♓",
        };

        const SIGN_DESC = {
          belier:
            "Énergie d’action et d’élan. On explore ton impulsion, ta colère (quand elle monte), et comment canaliser ton courage sans te brûler.",
          taureau:
            "Besoin de stabilité et de concret. On explore l’attachement, le plaisir, la sécurité intérieure, et comment lâcher sans perdre ton ancrage.",
          gemeaux:
            "Mental rapide et curiosité. On explore tes pensées en boucle, ta dualité, et comment clarifier ce que tu ressens derrière ce que tu analyses.",
          cancer:
            "Hyper-sensibilité et protection. On explore tes besoins affectifs, tes limites, et comment te sentir en sécurité sans tout porter seul·e.",
          lion:
            "Rayonnement et fierté du cœur. On explore l’estime de soi, la reconnaissance, et comment briller sans te suradapter au regard des autres.",
          vierge:
            "Lucidité et exigence. On explore le contrôle, la charge mentale, et comment trouver du calme quand tu veux que tout soit “bien fait”.",
          balance:
            "Équilibre et relation. On explore la peur du conflit, le besoin d’harmonie, et comment dire “non” sans culpabilité.",
          scorpion:
            "Intensité et transformation. On explore la confiance, la jalousie/la peur de perdre, et comment traverser une émotion sans te fermer.",
          sagittaire:
            "Sens et liberté. On explore l’ennui, l’envie d’ailleurs, et comment rester aligné·e quand tu te sens coincé·e ou limité·e.",
          capricorne:
            "Structure et responsabilité. On explore la pression, la performance, et comment te reposer sans te sentir “inutile”.",
          verseau:
            "Indépendance et vision. On explore la distance émotionnelle, ton besoin d’espace, et comment te connecter sans te sentir envahi·e.",
          poissons:
            "Intuition et empathie. On explore l’hypersensibilité, la fatigue émotionnelle, et comment te protéger sans t’éteindre.",
        };

        const SIGN_BOOKS = {
          belier: "https://a.co/d/ipv7KsG",
          taureau: "https://a.co/d/cNzESwI",
          gemeaux: "https://a.co/d/5rzhkCv",
          cancer: "https://a.co/d/9T3gj30",
          lion: "https://a.co/d/eQ0Fa2u",
          vierge: "https://a.co/d/7mMxP9f",
          balance: "https://a.co/d/i93cts5",
          scorpion: "https://a.co/d/0HQBCE8",
          sagittaire: "https://a.co/d/iOLDHqS",
          capricorne: "https://a.co/d/4JuWLu1",
          verseau: "https://a.co/d/de3Ukra",
          poissons: "https://a.co/d/hIM81yC",
        };

        const rawKey = qs("signe") || qs("sign") || "belier";
        const signKey = norm(rawKey) || "belier";
        const signName = SIGNS[signKey] || "—";
        const signDesc =
          SIGN_DESC[signKey] ||
          "Exploration douce : émotions, relations, stress, schémas, besoins, limites.";

        const signLabelEl = document.getElementById("signLabel");
        const aiTagEl = document.getElementById("aiTag");
        const aiDescEl = document.getElementById("aiDesc");
        const heroTitleEl = document.getElementById("heroTitle");
        const heroDescEl = document.getElementById("heroDesc");

        if (signLabelEl) signLabelEl.textContent = signName;
        if (aiTagEl) aiTagEl.textContent = "Signe : " + signName;
        if (aiDescEl) aiDescEl.textContent = signDesc;
        if (heroTitleEl) heroTitleEl.textContent = "Ton signe : " + signName;
        if (heroDescEl) heroDescEl.textContent = signDesc;

        const bookUrl = SIGN_BOOKS[signKey];
        const wrap = document.getElementById("aiBookWrap");
        const link = document.getElementById("aiBookLink");
        if (wrap && link && bookUrl) {
          wrap.style.display = "block";
          link.href = bookUrl;
        }

        /* =========================
           GUEST ID (pour limiter côté serveur)
        ========================= */
        const KEY_GUEST_ID = STORAGE_PREFIX + "guest_id";
        function getGuestId() {
          try {
            let id = localStorage.getItem(KEY_GUEST_ID);
            if (!id) {
              id =
                (crypto && crypto.randomUUID && crypto.randomUUID()) ||
                ("guest_" + Math.random().toString(36).slice(2) + Date.now());
              localStorage.setItem(KEY_GUEST_ID, id);
            }
            return id;
          } catch (_) {
            return "guest_" + Math.random().toString(36).slice(2) + Date.now();
          }
        }

        /* =========================
           CHAT UI
        ========================= */
        function addMessage(role, text) {
          const row = document.createElement("div");
          row.className = "msg-row " + (role === "ai" ? "msg-ai" : "msg-user");

          if (role === "ai") {
            const avatar = document.createElement("img");
            avatar.className = "msg-avatar";
            avatar.src = "./ia-luna-astralis.png";
            avatar.alt = "Luna (IA)";
            row.appendChild(avatar);
          } else {
            const spacer = document.createElement("div");
            spacer.className = "msg-avatar-spacer";
            row.appendChild(spacer);
          }

          const bubble = document.createElement("div");
          bubble.className = "msg-bubble";
          bubble.textContent = text;

          row.appendChild(bubble);
          messagesEl.appendChild(row);
          messagesEl.scrollTop = messagesEl.scrollHeight;
          return row;
        }

        function replaceLastAiTyping(newText) {
          const last = messagesEl.querySelector(".msg-row.msg-ai:last-child .msg-bubble");
          if (last && last.textContent === "…") {
            last.textContent = newText;
            return true;
          }
          return false;
        }

        /* =========================
           CALL YOUR SERVER (OpenAI)
           IMPORTANT: requires /api/chat on Vercel
        ========================= */
        async function askLuna(userText, threadForContext, isAuth) {
          const payload = {
            message: userText,
            signKey,
            signName,
            signDesc,
            mode: isAuth ? "auth" : "guest",
            guestId: isAuth ? null : getGuestId(),
            // on envoie juste un petit contexte récent
            history: (threadForContext || []).slice(-12),
          };

          const res = await fetch("/api/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          const data = await res.json().catch(() => ({}));

          if (!res.ok) {
            // si l'API renvoie FREE_LIMIT_REACHED, on ouvre le popup
            if (data?.error === "FREE_LIMIT_REACHED") {
              openPaywall();
              throw new Error("FREE_LIMIT_REACHED");
            }
            const err = data?.error || "Erreur serveur (/api/chat).";
            throw new Error(err);
          }

          if (!data?.reply) throw new Error("Réponse vide.");
          return data.reply;
        }

        /* =========================
           STORAGE (guest)
        ========================= */
        const KEY_THREAD = STORAGE_PREFIX + "thread_" + signKey;
        const KEY_COUNT = STORAGE_PREFIX + "count_" + signKey;
        const KEY_MIGRATED = STORAGE_PREFIX + "migrated_" + signKey;

        function loadGuestThread() {
          try {
            const raw = localStorage.getItem(KEY_THREAD);
            const arr = raw ? JSON.parse(raw) : [];
            return Array.isArray(arr) ? arr : [];
          } catch (_) {
            return [];
          }
        }

        function saveGuestThread(arr) {
          try {
            localStorage.setItem(KEY_THREAD, JSON.stringify(arr || []));
          } catch (_) {}
        }

        function getGuestCount() {
          const n = Number(localStorage.getItem(KEY_COUNT) || "0");
          return Number.isFinite(n) ? n : 0;
        }

        function incGuestCount() {
          const n = getGuestCount() + 1;
          try { localStorage.setItem(KEY_COUNT, String(n)); } catch (_) {}
          return n;
        }

        function setModeGuest() {
          if (modeText) modeText.textContent = "Invité";
          if (modeDot) modeDot.classList.remove("green");
          if (logoutLink) logoutLink.style.display = "none";
          if (upgradeLink) upgradeLink.style.display = "none";
          if (userEmailEl) userEmailEl.textContent = "";
          updateFreeCounter(false);
        }

        function setModeAuth(email) {
          if (modeText) modeText.textContent = "Connecté";
          if (modeDot) modeDot.classList.add("green");
          if (logoutLink) logoutLink.style.display = "inline";
          if (userEmailEl) userEmailEl.textContent = email || "";
          updateFreeCounter(true);
        }

        function updateFreeCounter(isAuth) {
          if (!freeCounterEl) return;
          if (isAuth) {
            freeCounterEl.textContent = "";
            return;
          }
          const used = getGuestCount();
          const left = Math.max(0, FREE_LIMIT - used);
          freeCounterEl.textContent =
            left > 0 ? `Gratuit : ${left} message(s) restant(s)` : `Limite gratuite atteinte`;
        }

        /* =========================
           PAYWALL
        ========================= */
        function openPaywall() {
          if (!paywallEl) return;
          if (paywallLogin) paywallLogin.href = loginUrl();
          if (paywallPricing) paywallPricing.href = pricingUrl();
          paywallEl.style.display = "flex";
        }
        function closePaywall() {
          if (!paywallEl) return;
          paywallEl.style.display = "none";
        }

        if (paywallClose) paywallClose.addEventListener("click", closePaywall);
        if (paywallEl) {
          paywallEl.addEventListener("click", (e) => {
            if (e.target === paywallEl) closePaywall();
          });
        }

        /* =========================
           AUTH
        ========================= */
        let SESSION = null;

        async function getSession() {
          try {
            const { data, error } = await supabase.auth.getSession();
            if (error) return null;
            return data?.session || null;
          } catch (_) {
            return null;
          }
        }

        async function ensureConversation(session) {
          const cacheKey = STORAGE_PREFIX + "conv_" + signKey;
          const cached = localStorage.getItem(cacheKey);
          if (cached) return cached;

          const user_id = session.user.id;

          let convId = null;
          try {
            let r = await supabase
              .from("conversations")
              .insert([{ user_id, sign_key: signKey }])
              .select("id")
              .single();

            if (!r.error && r.data?.id) convId = r.data.id;
          } catch (_) {}

          if (!convId) {
            try {
              let r2 = await supabase
                .from("conversations")
                .insert([{ user_id }])
                .select("id")
                .single();

              if (!r2.error && r2.data?.id) convId = r2.data.id;
            } catch (_) {}
          }

          if (!convId) return null;

          try { localStorage.setItem(cacheKey, convId); } catch (_) {}
          return convId;
        }

        async function saveMessageDB(session, conversation_id, role, content) {
          const user_id = session.user.id;
          const payload = { user_id, role, content, conversation_id };
          const { error } = await supabase.from("chat_messages").insert([payload]);
          return !error;
        }

        async function migrateGuestToDB(session) {
          try {
            if (localStorage.getItem(KEY_MIGRATED) === "1") return;
          } catch (_) {}

          const thread = loadGuestThread();
          if (!thread.length) {
            try { localStorage.setItem(KEY_MIGRATED, "1"); } catch (_) {}
            return;
          }

          const conversation_id = await ensureConversation(session);
          if (!conversation_id) return;

          for (const m of thread) {
            const ok = await saveMessageDB(session, conversation_id, m.role, m.text);
            if (!ok) return;
          }

          try { localStorage.setItem(KEY_MIGRATED, "1"); } catch (_) {}
        }

        /* =========================
           INIT
        ========================= */
        function renderThread(thread) {
          messagesEl.innerHTML = "";
          for (const m of thread) addMessage(m.role, m.text);
        }

        function bootGuest() {
          setModeGuest();

          const thread = loadGuestThread();
          if (thread.length) {
            renderThread(thread);
          } else {
            const hello =
              "Salut ✨ Tu peux commencer sans compte. Dis-moi ce que tu veux comprendre aujourd’hui (émotions, relations, stress, schémas…).";
            addMessage("ai", hello);
            saveGuestThread([{ role: "ai", text: hello }]);
          }
        }

        async function bootAuth(session) {
          const email = session.user?.email || "";
          setModeAuth(email);

          await migrateGuestToDB(session);

          const thread = loadGuestThread();
          if (thread.length) {
            renderThread(thread);
          } else {
            addMessage(
              "ai",
              "Salut ✨ Dis-moi ce que tu veux comprendre aujourd’hui (émotions, relations, stress, schémas…)."
            );
          }
        }

        (async () => {
          SESSION = await getSession();
          if (SESSION) await bootAuth(SESSION);
          else bootGuest();
        })();

        /* =========================
           SEND (NOW CALLS /api/chat)
        ========================= */
        async function handleSend(userText, isAuth) {
          // on prend le thread local comme contexte (simple)
          const thread = loadGuestThread();
          const reply = await askLuna(userText, thread, isAuth);
          return reply;
        }

        if (form) {
          form.addEventListener("submit", async (e) => {
            e.preventDefault();

            const text = (input && input.value ? input.value : "").trim();
            if (!text) return;

            // refresh session
            SESSION = await getSession();

            // ===== GUEST MODE =====
            if (!SESSION) {
              // (UI) limite locale + (Serveur) limite réelle
              const used = getGuestCount();
              if (used >= FREE_LIMIT) {
                openPaywall();
                updateFreeCounter(false);
                return;
              }

              addMessage("user", text);
              const n = incGuestCount();
              updateFreeCounter(false);

              const thread = loadGuestThread();
              thread.push({ role: "user", text });
              saveGuestThread(thread);

              if (input) { input.value = ""; input.focus(); }

              // typing
              addMessage("ai", "…");

              try {
                const reply = await handleSend(text, false);

                replaceLastAiTyping(reply) || addMessage("ai", reply);

                const t2 = loadGuestThread();
                t2.push({ role: "ai", text: reply });
                saveGuestThread(t2);

                if (n >= FREE_LIMIT) {
                  openPaywall();
                  updateFreeCounter(false);
                }
              } catch (err) {
                if (err?.message === "FREE_LIMIT_REACHED") {
                  // le serveur a bloqué -> popup déjà ouvert
                  replaceLastAiTyping("Tu as atteint la limite gratuite. Crée un compte (gratuit) ou choisis une offre pour continuer.") ||
                    addMessage("ai", "Tu as atteint la limite gratuite. Crée un compte (gratuit) ou choisis une offre pour continuer.");
                  updateFreeCounter(false);
                  return;
                }

                const msg =
                  "Erreur. Vérifie que /api/chat existe sur Vercel. " +
                  (err?.message ? ("(" + err.message + ")") : "");
                replaceLastAiTyping(msg) || addMessage("ai", msg);
              }

              return;
            }

            // ===== AUTH MODE =====
            addMessage("user", text);
            if (input) { input.value = ""; input.focus(); }

            const conversation_id = await ensureConversation(SESSION);
            if (conversation_id) await saveMessageDB(SESSION, conversation_id, "user", text);

            // typing
            addMessage("ai", "…");

            try {
              const reply = await handleSend(text, true);

              replaceLastAiTyping(reply) || addMessage("ai", reply);

              if (conversation_id) await saveMessageDB(SESSION, conversation_id, "ai", reply);

              // aussi garder local (simple)
              const t2 = loadGuestThread();
              t2.push({ role: "user", text });
              t2.push({ role: "ai", text: reply });
              saveGuestThread(t2);
            } catch (err) {
              const msg =
                "Erreur. Vérifie que /api/chat existe sur Vercel. " +
                (err?.message ? ("(" + err.message + ")") : "");
              replaceLastAiTyping(msg) || addMessage("ai", msg);
            }
          });
        }

        /* =========================
           LOGOUT
        ========================= */
        if (logoutLink) {
          logoutLink.addEventListener("click", async (e) => {
            e.preventDefault();
            await supabase.auth.signOut();
            SESSION = null;
            closePaywall();
            bootGuest();
          });
        }

        /* =========================
           UPGRADE (optionnel)
        ========================= */
        if (upgradeLink) upgradeLink.href = pricingUrl();

        /* =========================
           Auth change
        ========================= */
        supabase.auth.onAuthStateChange(async (event, session) => {
          SESSION = session || null;
          closePaywall();
          if (SESSION) await bootAuth(SESSION);
          else bootGuest();
        });

        // Liens paywall
        if (paywallLogin) paywallLogin.href = loginUrl();
        if (paywallPricing) paywallPricing.href = pricingUrl();
      })();
    </script>
  </body>
</html>
